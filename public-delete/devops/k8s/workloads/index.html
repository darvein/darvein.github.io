<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self' https://www.dropbox.com https://*.dl.dropboxusercontent.com https://photos.app.goo.gl https://drive.google.com https://photos.google.com https://video-downloads.googleusercontent.com https://*.googleusercontent.com https://*.googlevideo.com https://youtube.googleapis.com; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://w.soundcloud.com https://www.youtube.com https://www.youtube-nocookie.com https://www.dropbox.com http://localhost https://www.dropbox.com http://darvein.local https://disqus.com; img-src 'self' https://photos.google.com https://lh3.googleusercontent.com https://www.dropbox.com https://*.dl.dropboxusercontent.com https://*.disqus.com https://c.disquscdn.com; object-src https://lh3.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://www.dropbox.com http://localhost http://darvein.local https://drv21.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://youtube.googleapis.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Dennis Ruiz"><meta name=description content="Workloads Objects in kubernetes Pods have unique name All k8s objects have an UID labels and selectors to tag and organize objects, helpful from cli or UI. kubectl get pods -l environment=production,tier=frontend kubectl get pods -l 'environment,environment notin (frontend)' Recommended labels: app.kubernetes.io/name: mysql app.kubernetes.io/instance: mysql-abcxzy app.kubernetes.io/version: &#34;5.7.21&#34; app.kubernetes.io/component: database app.kubernetes.io/part-of: wordpress app.kubernetes.io/managed-by: helm Namespaces, are used as environments (useful to allocate users via Resource Quota) DNS when creating a service: <service-name>."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Workloads Objects in kubernetes Pods have unique name All k8s objects have an UID labels and selectors to tag and organize objects, helpful from cli or UI. kubectl get pods -l environment=production,tier=frontend kubectl get pods -l 'environment,environment notin (frontend)' Recommended labels: app.kubernetes.io/name: mysql app.kubernetes.io/instance: mysql-abcxzy app.kubernetes.io/version: &#34;5.7.21&#34; app.kubernetes.io/component: database app.kubernetes.io/part-of: wordpress app.kubernetes.io/managed-by: helm Namespaces, are used as environments (useful to allocate users via Resource Quota) DNS when creating a service: <service-name>."><meta property="og:title" content><meta property="og:description" content="Workloads Objects in kubernetes Pods have unique name All k8s objects have an UID labels and selectors to tag and organize objects, helpful from cli or UI. kubectl get pods -l environment=production,tier=frontend kubectl get pods -l 'environment,environment notin (frontend)' Recommended labels: app.kubernetes.io/name: mysql app.kubernetes.io/instance: mysql-abcxzy app.kubernetes.io/version: &#34;5.7.21&#34; app.kubernetes.io/component: database app.kubernetes.io/part-of: wordpress app.kubernetes.io/managed-by: helm Namespaces, are used as environments (useful to allocate users via Resource Quota) DNS when creating a service: <service-name>."><meta property="og:type" content="article"><meta property="og:url" content="https://www.darvein.net/devops/k8s/workloads/"><meta property="article:section" content="devops"><title>Workloads </title><link rel=canonical href=https://www.darvein.net/devops/k8s/workloads/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1a7e7e7bd8b6629931805334fd6cf056ee6f154702847e6d597bbfe80446a0d.css integrity="sha256-oafn572LZimTGAUzT9bPBW7m8VRwKEfm1Ze7/oBEag0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.7cf8a329bb485491ed5be45bd286916c655bf66e11e3fe4d82649437eae8b51b.css integrity="sha256-fPijKbtIVJHtW+Rb0oaRbGVb9m4R4/5NgmSUN+rotRs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.120.4"></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Darvein
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/infosec/>Infosec</a></li><li class=navigation-item><a class=navigation-link href=/coding/>Coding</a></li><li class=navigation-item><a class=navigation-link href=/devops/>Devops</a></li></ul></section></nav><div class=content><section class="container page"><article><h1 id=workloads>Workloads
<a class=heading-link href=#workloads><i class="fa fa-link" aria-hidden=true></i></a></h1><h3 id=objects-in-kubernetes>Objects in kubernetes
<a class=heading-link href=#objects-in-kubernetes><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>Pods have unique name</li><li>All k8s objects have an UID</li><li><code>labels</code> and <code>selectors</code> to tag and organize objects, helpful from cli or UI.<ul><li><code>kubectl get pods -l environment=production,tier=frontend</code></li><li><code>kubectl get pods -l 'environment,environment notin (frontend)'</code></li><li>Recommended labels:</li></ul><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#fb660a;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#888> </span>mysql<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>app.kubernetes.io/instance</span>:<span style=color:#888> </span>mysql-abcxzy<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>app.kubernetes.io/version</span>:<span style=color:#888> </span><span style=color:#0086d2>&#34;5.7.21&#34;</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>app.kubernetes.io/component</span>:<span style=color:#888> </span>database<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>app.kubernetes.io/part-of</span>:<span style=color:#888> </span>wordpress<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>app.kubernetes.io/managed-by</span>:<span style=color:#888> </span>helm<span style=color:#888>
</span></span></span></code></pre></div></li><li>Namespaces, are used as environments (useful to allocate users via Resource Quota)<ul><li>DNS when creating a service: <code>&lt;service-name>.&lt;namespace-name>.svc.cluster.local</code></li><li>Not everything has a namespace, see what are those: <code>kubectl api-resources --namespaced=false</code></li></ul></li><li>Annotations, not queri-able like Labels and can contain structured & unstructured obj information (build, client lib info, urls, etc)</li><li>Owners and dependents, for eg. <strong>ReplicaSet</strong> is owner of a set of <strong>Pods</strong>, <strong>Service</strong> owns <strong>EndpointSlice</strong>.</li></ul><h3 id=kubernetes-components>Kubernetes components
<a class=heading-link href=#kubernetes-components><i class="fa fa-link" aria-hidden=true></i></a></h3><p><strong>Control Plane</strong>:</p><ul><li>kube-apiserver: exposes k8s API, scales horizontally (scales by deploying more insatnces of the app)</li><li>etcd: HA key-value store for cluster data</li><li>kube-scheduler: watches new pods without nodes, selects a node for them to run. Manages scheduling decisions(hardware/software/policy constraints, affinity, etc)</li><li>kube-controler-manager: multiple controllers into a single binary (node, job, endpointslice, serviceAccount controllers)</li><li>cloud-controller-manager: bunch of binaries (node, route, service controllers)</li></ul><p><strong>Node components</strong>:</p><ul><li>kubelet: make sure containers are running in a pod</li><li>kube-proxy: network proxy that allow pods communicate inside/outside of the cluster</li></ul><h3 id=on-prem-scenarios>On-prem scenarios
<a class=heading-link href=#on-prem-scenarios><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>Ansible Kubespray (for medium-large setups)</li><li>Kubeadm (for small, demos)</li><li>Rancher RKE <code>rke up</code> (it requieres cluster.yml)</li><li>Redhat Openshift</li><li>VMware Tanzu Kubernetes</li></ul><p>Reasons?: Compliances, cheaper, agnostic,</p><p>Critical components:</p><ul><li>Etcd HA (backups)</li><li>LB: f5, metallb, haproxy</li><li>HA: multiple nodes AZ</li><li>Persistent Storage: via CSI plugins (block or file storage)</li><li>Upgrades, every 3 mo</li><li>Master nodes, quorum min 3, max 7</li><li>Node reqs: 32 cpu cores, 2tb ram?, 4 SSDs, 8 Sata SSDs, 2 10G eths</li></ul><h3 id=containers>Containers
<a class=heading-link href=#containers><i class="fa fa-link" aria-hidden=true></i></a></h3><p>A container image is like a software package that is inmutable. A container engine is the service where the image is executed/ran. Kubernetes supports container runtimes accepted by CRI (container runtime interface) like docker, containerd, cri-o.</p><p>Kubernetes has <code>imagePullPolicy</code> pull policy that specifies whether k8s should pull always <code>Always</code>, never <code>Never</code> or if the image doesn&rsquo;t exist locally <code>IfNotPresent</code>. As best practice, avoid using <code>:latest</code> images, it makes harder to rollback to previous image which is also <code>:latest</code>. You can also specify an image digest in the name: <code>server-image.com:image-name:thetag@sha256:xxxxxxxxxxxxx</code></p><p><strong>Authentication</strong>, keep in mind that Kubernetes needs to be authenticated against the Image Repository by using k8s Secrets.</p><h3 id=workloads-1>Workloads
<a class=heading-link href=#workloads-1><i class="fa fa-link" aria-hidden=true></i></a></h3><p>Container images are deployed in Pods on kubernetes. Kubernetes itself manages the workload via Controllers to make sure Pods are properly created across the cluster nodes</p><p>The following are built-in workload objects: Deployment and ReplicaSet, StatefulSet, DaemonSet, Job and CronJob. If you need to have an special kind of workload that doesn&rsquo;t exist you can create your own by using a CRD (custom resource definition).</p><h4 id=pods>Pods
<a class=heading-link href=#pods><i class="fa fa-link" aria-hidden=true></i></a></h4><ul><li>Pods are created on your behalf via <em>Deployment</em>, <em>StatefulSet</em> or <em>DaemonSet</em></li><li>Pods can share context via linux namespaces, cgroups. So multiple containers can run in the same context.<ul><li>Containers in the pod share the same networ, same IP</li><li>Containers can share Storage volume</li><li>A container in a pod can run with enabled privileges via <code>privileged</code> on linux, on windows is <code>windowsOptions.hostProcess</code></li></ul></li><li>A pod can have a single container or multiple containers (logs/metrics collection, config reload watcher, proxies like envoy/istio)</li><li>You can modify a running Pod via <code>patch</code> or <code>replace</code> but it has limitations. You cannot modify most of the metadata. Maybe <code>spec.containers[*]</code>, <code>spec.initContainers[*]</code>, <code>spec.tolerations</code></li><li>Lifecycle: <code>Pending</code>, <code>Running</code>, <code>Succeeded</code>, <code>Failed</code>, <code>Unknown</code></li><li>Probes:<ul><li>Check mechanisms: <code>exec</code>, <code>grpc</code>, <code>httpGet</code>, <code>tcpSocket</code></li><li>Probe outcome: <code>Success</code>, <code>Failure</code>, <code>Unknown</code></li><li>Types of probe: <code>livenessProbe</code>, <code>readinessProbe</code>, <code>startupProbe</code></li></ul></li><li>Termination of a pod: By default it has a grace of 30 seconds via signal <code>SIGTERM</code>. Or rather you can specify <code>--grace-period=0</code> to quickly terminate the pod.</li><li>Pod can have Init Containers, these are containers that are first executed in order to do some previous work before running the App Containers. Work like cloning a git repo, configuring or resolving secrets, just waiting for some external http dependencies, etc.<ul><li>There can be multiple init containers defined in <code>spec</code> in the manifest yaml file</li><li>Init containers cannot have ports linked to a Service</li><li>A pod cannot be <code>Ready</code> until init containers have succeeded</li></ul></li><li>PodDisruptionBudget (?)</li><li>You cannot add containers to a running Pod<ul><li>You need to troubleshoot? then <em>Ephemeral Containers</em> via <code>kubectl debug (POD_NAME) --image=(DEBUG_IMAGE) --target=(EXISTING_CONTAINER_NAME)</code>. Once this is running then you can <code>kubectl attach</code> or <code>kubectl exec</code>, then start analyzing the Pod.</li></ul></li></ul><h4 id=workload-resources>Workload resources
<a class=heading-link href=#workload-resources><i class="fa fa-link" aria-hidden=true></i></a></h4><p>Built-in workloads are:</p><ul><li>Deployment (ReplicaSet indirectly)</li><li>StatefulSet</li><li>Daemonset</li><li>Job & Cronjob</li></ul><h5 id=deployments>Deployments
<a class=heading-link href=#deployments><i class="fa fa-link" aria-hidden=true></i></a></h5><p>Deployment -> ReplicaSet -> Pod. This is managed by the Deployment Controller in k8s master cluster.</p><p>We can do:</p><ul><li>Check deployment status: <code>k get deployments</code></li><li>Rollout status: <code>k rollout status deployment/nginx-deployment</code></li><li>Rollout history: <code>k rollout history deployment/nginx-deployment</code></li><li>Rollout rollback via undo: <code>k rollout undo deployment/nginx-deployment</code></li><li>Scaling a Deployment: <code>k scale deployment/nginx-deployment --replicas=10</code></li><li>Check the replica sets: <code>k get rs</code></li><li>Update a Deployment: <code>k set image deployment/nginx-deployment nginx=nginx:1.16.1</code></li><li>Edit a Deployment: <code>k edit deployment/nginx-deployment</code></li><li>Describe a Deployment: <code>k describe deployment/nginx-deployment</code><ul><li>It is important to pay attention to the <strong>Conditions:</strong> section, there you can see errors if any</li></ul></li><li>Via deployment spec <code>.spec.strategy</code> we can specify <strong>RollingUpdate</strong> or <strong>Recreate</strong> deployments. Also the proportional rolling deployments</li></ul><h5 id=replicaset>ReplicaSet
<a class=heading-link href=#replicaset><i class="fa fa-link" aria-hidden=true></i></a></h5><ul><li>Get RS: <code>k get rs</code></li><li>Describe RS: <code>kubectl describe rs/frontend</code></li><li>Delete a RS: Can be done via <code>k delete</code> but also via <code>k proxy</code> k8s API. We can delete the RS and its Pods or just the RS alone.</li><li>A RS can be scaled via HPA (horizontal pod autoscaler) <strong>HorizontalPodAutoscaler</strong> kind object where we specify a RS, minReplicas, maxReplicas, it can also work via cli <code>k autoscale rs frontend --max=10 --min=3 --cpu-percent=50</code></li></ul><h5 id=statefulset>StatefulSet
<a class=heading-link href=#statefulset><i class="fa fa-link" aria-hidden=true></i></a></h5><ul><li>Works similar to <strong>Deployment</strong> but not controls via RS Controller it uses StatefulSet Controller instead</li><li>Statefulset unline Deployment is not interchangeable, a pod can die and a new one born with different IP or name, a Statefulste pod if dies will always be recreated with same name and IP and its replicas will be numered like <code>web-0</code>, <code>web-1</code>, etc.</li><li>It has stable and persistent Storage</li><li>This StatefulSet have: unique network identifiers, persistent storage, ordered and graceful deployments/scalings/rolling<ul><li>Storave PVC is only for one uniq statefulset pod, it is not shared with other pods</li></ul></li><li>Deployments: Termination of pods are in reverse order. Before Scaling all pods predecessors must be Running/Ready<ul><li>Pods are Started, Scaled, Terminated in a strict order FIFO</li><li>No rollbacks allowed</li><li>Via <code>.spec.updateStrategy.type</code> property can be specified <strong>RollingUpdate</strong> and Partitions(?)<ul><li>It can also specify <code>.spec.updateStrategy.rollingUpdate.maxUnavailable</code></li></ul></li></ul></li><li>Storage have policies via <code>spec.persistentVolumeClaimRetentionPolicy</code><ul><li>Volumes are not deleted by default (when deleting the pod or scaling down)</li><li>By default it <strong>Retain</strong> a PVC, but it can also be <strong>Delete</strong>, when <strong>whenDeleted</strong> or <strong>whenScaled</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#fb660a;font-weight:700>spec</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>persistentVolumeClaimRetentionPolicy</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>whenDeleted</span>:<span style=color:#888> </span>Retain<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>whenScaled</span>:<span style=color:#888> </span>Delete<span style=color:#888>
</span></span></span></code></pre></div></li><li>It requires <strong>Headless Services</strong> for network identity, this way it doesn&rsquo;t load-balance anything as it is not needed.</li><li>When a PVC/PV is created for a Statefulset service, if not specified by default will use the <code>hostPath</code> storage type.</li></ul><h5 id=daemonset>DaemonSet
<a class=heading-link href=#daemonset><i class="fa fa-link" aria-hidden=true></i></a></h5><p>Pods defined as <strong>DaemonSet</strong> are ensured to run across all nodes, one copy each node via DaemonSet Controller.</p><p>Use cases: cluster storage daemon, logs collection, node monitoring</p><p>Notes:</p><ul><li>Via <code>spec.affinity.nodeAffinity</code><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#fb660a;font-weight:700>nodeAffinity</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>requiredDuringSchedulingIgnoredDuringExecution</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>nodeSelectorTerms</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span>- <span style=color:#fb660a;font-weight:700>matchFields</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>      </span>- <span style=color:#fb660a;font-weight:700>key</span>:<span style=color:#888> </span>metadata.name<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>operator</span>:<span style=color:#888> </span>In<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>values</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>        </span>- target-host-name<span style=color:#888>
</span></span></span></code></pre></div></li><li>Communication:<ul><li>Service: a service can be put on top (via labels matching) and then reach a random pod daemon from any node</li><li>DNS: via <code>endpoints</code> discover daemonsets via pod selectors</li></ul></li></ul><h5 id=jobs>Jobs
<a class=heading-link href=#jobs><i class="fa fa-link" aria-hidden=true></i></a></h5><p>Runs a pod until it succesfully terminates (exit code 0). If the pod fails for some reason then it is run again.</p><p>Notes:</p><ul><li>The <code>RestartPolicy</code> can be <em>Never</em> or <em>OnFailure</em> only</li><li>Parallelism<ul><li>Jobs can be run on parallel or not based on properties <code>.spec.completions</code> and <code>.spec.parallelism</code><ul><li>If not specified, both values are defaulted to 1</li></ul></li><li><code>completionMode</code> can be <strong>Indexed</strong> or <strong>NonIndexed</strong>.<ul><li>When <strong>Indexed</strong>: at least one of the jobs in the index cluster has to be success in order to complete the job</li><li>When <strong>NonIndexed</strong>: all jobs have to be completed succesfully in order to consider the job completed</li></ul></li></ul></li><li>Failures<ul><li>Can be specified in <code>.spec.backoffLimit</code>, by default is <code>6</code> with exponential back-off delays (10s, 20s, 40s)</li><li>Each index job can also have its back off limit via <code>.spec.backoffLimitPerIndex</code></li><li><code>restartPolicy</code> has to be set to <strong>Never</strong></li><li>Example:<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>batch/v1<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>Job<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>job-backoff-limit-per-index-example<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>spec</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>completions</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>10</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>parallelism</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>3</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>completionMode</span>:<span style=color:#888> </span>Indexed <span style=color:#888> </span><span style=color:#080;background-color:#0f140f;font-style:italic># required for the feature</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>backoffLimitPerIndex</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>1</span><span style=color:#888>  </span><span style=color:#080;background-color:#0f140f;font-style:italic># maximal number of failures per index</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>maxFailedIndexes</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>      </span><span style=color:#080;background-color:#0f140f;font-style:italic># maximal number of failed indexes before terminating the Job execution</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>template</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>spec</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>restartPolicy</span>:<span style=color:#888> </span>Never<span style=color:#888> </span><span style=color:#080;background-color:#0f140f;font-style:italic># required for the feature.</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>containers</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>      </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>example<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>image</span>:<span style=color:#888> </span>python<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>command</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>              </span>- id<span style=color:#888>
</span></span></span></code></pre></div></li><li>Pod failure policy: we can customize and exit codes:<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>...<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>backoffLimit</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>6</span><span style=color:#888>             </span><span style=color:#080;background-color:#0f140f;font-style:italic># This retries the whole job, it also works for parallelism</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>podFailurePolicy</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>rules</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span>- <span style=color:#fb660a;font-weight:700>action</span>:<span style=color:#888> </span>FailJob<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>onExitCodes</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>containerName</span>:<span style=color:#888> </span>main     <span style=color:#888> </span><span style=color:#080;background-color:#0f140f;font-style:italic># optional</span><span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>operator: In             # one of</span>:<span style=color:#888> </span>In, NotIn<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>values</span>:<span style=color:#888> </span>[<span style=color:#0086f7;font-weight:700>42</span>]<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888></span>- <span style=color:#fb660a;font-weight:700>action: Ignore             # one of</span>:<span style=color:#888> </span>Ignore, FailJob, Count<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>onPodConditions</span>:<span style=color:#888>
</span></span></span><span style=display:flex><span><span style=color:#888>  </span>- <span style=color:#fb660a;font-weight:700>type</span>:<span style=color:#888> </span>DisruptionTarget  <span style=color:#888> </span><span style=color:#080;background-color:#0f140f;font-style:italic># indicates Pod disruption</span><span style=color:#888>
</span></span></span></code></pre></div><ul><li>Valid Actions are: FailJob, Ignore, Count, FailIndex</li></ul></li></ul></li><li>Clean up and Terminations:<ul><li>By default the Job and Pods are not removed, in case you want to check logs. You have to manually delete via <code>k delete</code></li><li>We can kill longer job pods via <code>.spec.activeDeadlineSeconds</code> property if we want to limit time execution</li><li>We can automatically clean up jobs and pods if we want via prop <code>.spec.ttlSecondsAfterFinished</code></li></ul></li><li>Jobs pods can be suspended (suspended=true)</li></ul><p>Then we can check the status with: <code>k get -o yaml job job-backoff-limit-per-index-example</code></p><h5 id=cronjob>Cronjob
<a class=heading-link href=#cronjob><i class="fa fa-link" aria-hidden=true></i></a></h5><p>Cronjob creates Jobs on a repeating schedule.</p><p>Some definitions:</p><ul><li>You can specify timezone: <code>spec.timeZone: "Etc/UTC"</code></li></ul><p>Use cases: backups, report generation</p><p>Notes:</p><ul><li>It specifies a <code>.spec.jobTemplate</code> section<ul><li>Via <code>.spec.schedule</code> we define when to run the job</li></ul></li><li>It supports concurrency via <code>.spec.concurrencyPolicy</code> with values: Allow, Forbid, Replace</li></ul><h5 id=replicationcontroller>ReplicationController
<a class=heading-link href=#replicationcontroller><i class="fa fa-link" aria-hidden=true></i></a></h5><p>Ensure the specified number of pods are running in the cluster. It is similar to a Deployment. Deployment is replacement of ReplicationController.</p><h2 id=topics-to-review>Topics to review
<a class=heading-link href=#topics-to-review><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>Kubernetes architecture: control plane, etcd, api server, scheduler, controllers<ul><li>nodes: kubelet, container runtime, kube-proxy</li><li>authentication and authorization</li></ul></li><li>How docker works?</li><li>deployment & services</li><li>configuration & secrets</li><li>ingress, statefulset, daemonset, jobs, crds</li><li>network policies, persisten volumes, storage classes</li><li>prometheus, grafana elk, fluentd</li><li>helm, fluxcd</li><li>rbac, security contexts</li><li>scaling: HPA and VPA, cluster autoscaling</li></ul><h2 id=random-notes>Random notes
<a class=heading-link href=#random-notes><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>kubectl exec, happens thanks to kube-api, kubelete and websockets via HTTPS</li><li>each pod has cgroups to limit resource allocations</li></ul><h2 id=todos>TODOs
<a class=heading-link href=#todos><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>Learn linux namespaces & cgroups</li><li>PoC run two containers in a pod. Ping container A to container B.</li></ul></article></section></div><footer class=footer><section class=container>©
2021 -
2024
Dennis Ruiz
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6CQZY8W0WD"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CQZY8W0WD")</script><script>$(document).on("input propertychange paste change",".FilterSearch",function(){var n=$(this).val().toLowerCase(),s=$(this).closest("ul"),t=s.find("li:gt(0)");t.hide(),t.filter(function(){var e=$(this).text().toLowerCase();return e.indexOf(n)>=0}).show()})</script></body></html>