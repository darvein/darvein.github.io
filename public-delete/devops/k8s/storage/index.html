<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self' https://www.dropbox.com https://*.dl.dropboxusercontent.com https://photos.app.goo.gl https://drive.google.com https://photos.google.com https://video-downloads.googleusercontent.com https://*.googleusercontent.com https://*.googlevideo.com https://youtube.googleapis.com; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://w.soundcloud.com https://www.youtube.com https://www.youtube-nocookie.com https://www.dropbox.com http://localhost https://www.dropbox.com http://darvein.local https://disqus.com; img-src 'self' https://photos.google.com https://lh3.googleusercontent.com https://www.dropbox.com https://*.dl.dropboxusercontent.com https://*.disqus.com https://c.disquscdn.com; object-src https://lh3.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://www.dropbox.com http://localhost http://darvein.local https://drv21.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://youtube.googleapis.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Dennis Ruiz"><meta name=description content="Storage Volumes Containers state are ephemeral, once the container is terminated then the Controller will recreate the container but data from the crashed/deleted container is lost. We can persist the container or containers data by using Volumes, but it will last only while the Pod is alive, once the Pod is eliminated then the volume is gone.
More references: kubectl explain pod.spec.volumes Pod have shared filesystem so all containers can share the files with a volume Ephemeral Volumes: emptyDir, configMap, secrets Persistent Volumes: hostPath, local, ebs (aws), etc Mount propagation: Which can be None, HostToContainer, Bidirectional."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Storage Volumes Containers state are ephemeral, once the container is terminated then the Controller will recreate the container but data from the crashed/deleted container is lost. We can persist the container or containers data by using Volumes, but it will last only while the Pod is alive, once the Pod is eliminated then the volume is gone.
More references: kubectl explain pod.spec.volumes Pod have shared filesystem so all containers can share the files with a volume Ephemeral Volumes: emptyDir, configMap, secrets Persistent Volumes: hostPath, local, ebs (aws), etc Mount propagation: Which can be None, HostToContainer, Bidirectional."><meta property="og:title" content><meta property="og:description" content="Storage Volumes Containers state are ephemeral, once the container is terminated then the Controller will recreate the container but data from the crashed/deleted container is lost. We can persist the container or containers data by using Volumes, but it will last only while the Pod is alive, once the Pod is eliminated then the volume is gone.
More references: kubectl explain pod.spec.volumes Pod have shared filesystem so all containers can share the files with a volume Ephemeral Volumes: emptyDir, configMap, secrets Persistent Volumes: hostPath, local, ebs (aws), etc Mount propagation: Which can be None, HostToContainer, Bidirectional."><meta property="og:type" content="article"><meta property="og:url" content="https://www.darvein.net/devops/k8s/storage/"><meta property="article:section" content="devops"><title>Storage </title><link rel=canonical href=https://www.darvein.net/devops/k8s/storage/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1a7e7e7bd8b6629931805334fd6cf056ee6f154702847e6d597bbfe80446a0d.css integrity="sha256-oafn572LZimTGAUzT9bPBW7m8VRwKEfm1Ze7/oBEag0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.7cf8a329bb485491ed5be45bd286916c655bf66e11e3fe4d82649437eae8b51b.css integrity="sha256-fPijKbtIVJHtW+Rb0oaRbGVb9m4R4/5NgmSUN+rotRs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.120.4"></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Darvein
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/infosec/>Infosec</a></li><li class=navigation-item><a class=navigation-link href=/coding/>Coding</a></li><li class=navigation-item><a class=navigation-link href=/devops/>Devops</a></li></ul></section></nav><div class=content><section class="container page"><article><h1 id=storage>Storage
<a class=heading-link href=#storage><i class="fa fa-link" aria-hidden=true></i></a></h1><h2 id=volumes>Volumes
<a class=heading-link href=#volumes><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Containers state are ephemeral, once the container is terminated then the Controller will recreate the container but data from the crashed/deleted container is lost. We can persist the container or containers data by using <strong>Volumes</strong>, but it will last only while the Pod is alive, once the Pod is eliminated then the volume is gone.</p><ul><li>More references: <code>kubectl explain pod.spec.volumes</code></li><li>Pod have shared filesystem so all containers can share the files with a <code>volume</code></li><li>Ephemeral Volumes: emptyDir, configMap, secrets</li><li>Persistent Volumes: hostPath, local, ebs (aws), etc</li></ul><p><strong>Mount propagation</strong>: Which can be <code>None</code>, <code>HostToContainer</code>, <code>Bidirectional</code>. This is about mounts on top of mounted volumes.</p><h2 id=persistent-volumes>Persistent Volumes
<a class=heading-link href=#persistent-volumes><i class="fa fa-link" aria-hidden=true></i></a></h2><p>These volumes can persist even if the Pod is terminated.</p><ul><li><code>PersistentVolume</code>: Piece of Storage attached to the cluster by an Administrator</li><li><code>PersistentVolumeClaim</code>: Request to a storage space by an user (Pods)</li></ul><p><strong>How PV and PVC work together</strong>: PV controller monitor Etcd looking for PVCs if found the it searchs for a valid PV and bound to it If not then checks for the storage class for dynamic provisioning of PV. Each storageClass have its own Provisioner.</p><p>Notes:</p><ul><li>If a PVC is deleted then it waits until no Pod is using it. If a PV is deleted then it waits until no PVC is using it.</li><li>A PV binding to a PVC is 1 to 1 mapping only.</li><li>volumeMode:<ul><li><code>Filesystem</code>: if the volume backed by a device is empty, k8s creates a filesystem before mounting it</li><li><code>Block</code>: No filesystem layer, much faster to write, the app in the pod needs to know how to handle Raw Block device</li></ul></li><li>acccessMode: ReadWriteOnce, ReadOnlyMany, ReadWriteMany, ReadWriteOncePod</li><li>storageClassName: if this is defined then the PVCs can get a PV with the specific class name</li><li>persistentVolumeReclaimPolicy:<ul><li>Retain: PVC is deleted but not the PV and also the storage</li><li>Delete: PVC and PV are deleted as well as the storage</li><li>Recycle: Performs rm -rf in the volume and it&rsquo;s available for new claims</li></ul></li><li>One single PVC can be used by multiple containers and use different folders by using: <code>subPath</code> and <code>subPathExpr</code></li><li>When using type &ldquo;local&rdquo;, k8s will make sure Pods that uses that PV are allocated in the nodeAffinity of the PV.<ul><li>The PV and local type must have nodeAffinity defined.</li></ul></li></ul><h2 id=persistent-volume-claim>Persistent Volume Claim
<a class=heading-link href=#persistent-volume-claim><i class="fa fa-link" aria-hidden=true></i></a></h2><p>These PVC have some properties similar from PVs and also:</p><ul><li>Selectors: The matchLabels and matchExpressions is ANDed and help to bound a PVC witht the PV.</li><li>Class: the class name PV where the PVC will be bound, of not specified then will be bound to the kids default classStorage, it can also be empty string &ldquo;&rdquo;.</li></ul><h3 id=snapshots>Snapshots
<a class=heading-link href=#snapshots><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>A PVC can be created from a volume snapshots via <code>.spec.dataSource</code>. It can also be created from another existing PVC.</li><li>PVC can also be prepopulated via <code>.spec.dataSourceRef</code> and a Custom Resource.</li></ul><h2 id=storage-class>Storage Class
<a class=heading-link href=#storage-class><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>Kubernetes has a default storageClass, it can have multilples but the latest one will have priority.</li><li>Each storageClass have its own Providioner that creates PVs</li></ul><h2 id=volume-snapshots>Volume Snapshots
<a class=heading-link href=#volume-snapshots><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>VolumeSnapshotContent is the resource and VolumeSnapshot is the request to create snapshots.</li><li>These snapshots can be pre-provsioned (manual creation of VolumeSnapshotContent) or Dynamic (via VolumeSnapshot) from a PVC</li></ul><h2 id=notes-for-the-lab>Notes for the lab
<a class=heading-link href=#notes-for-the-lab><i class="fa fa-link" aria-hidden=true></i></a></h2><p>no</p><ul><li>00: Pod with Volume <code>emptyDir</code></li><li>01: Pod NFS Volume</li><li>02: Configmap & secrets, read only</li><li>03: PV and PVC with <code>local</code> and <code>hostPath</code></li><li>04: Storage Class with EBS<ul><li>Reclaiming: Delete, Retain and Recycle</li></ul></li><li>05: Volume Snapshots
Meh</li></ul></article></section></div><footer class=footer><section class=container>©
2021 -
2024
Dennis Ruiz
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6CQZY8W0WD"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CQZY8W0WD")</script><script>$(document).on("input propertychange paste change",".FilterSearch",function(){var n=$(this).val().toLowerCase(),s=$(this).closest("ul"),t=s.find("li:gt(0)");t.hide(),t.filter(function(){var e=$(this).text().toLowerCase();return e.indexOf(n)>=0}).show()})</script></body></html>